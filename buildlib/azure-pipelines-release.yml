# See https://aka.ms/yaml
# This pipeline to be run on tags creation

trigger:
  tags:
    include:
      - v*
pr:
  - master
  - v*.*.x

variables:
  DOCKER_OPT_VOLUMES: -v /hpc/local:/hpc/local
  CENTOS7_CUDA_11_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/centos7-mofed5-cuda11:3
  CENTOS8_CUDA_11_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/centos8-mofed5-cuda11:3
  UBUNTU16_CUDA_11_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu16.04-mofed5-cuda11:3
  UBUNTU18_CUDA_11_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu18.04-mofed5-cuda11:3
  UBUNTU20_CUDA_11_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu20.04-mofed5-cuda11:3
  UBUNTU22_CUDA_11_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu22.04-mofed5-cuda11:3
  CENTOS7_CUDA_12_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/centos7-mofed5-cuda12:3
  UBUNTU18_CUDA_12_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu18.04-mofed5-cuda12:3
  UBUNTU20_CUDA_12_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu20.04-mofed5-cuda12:3
  UBUNTU22_CUDA_12_X86_64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu22.04-mofed5-cuda12:3
  CENTOS8_CUDA_11_AARCH64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/aarch64/centos8-mofed5-cuda11:3
  UBUNTU18_CUDA_11_AARCH64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/aarch64/ubuntu18.04-mofed5-cuda11:3
  UBUNTU20_CUDA_11_AARCH64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/aarch64/ubuntu20.04-mofed5-cuda11:3
  UBUNTU22_CUDA_11_AARCH64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/aarch64/ubuntu22.04-mofed5-cuda11:3
  UBUNTU20_CUDA_12_AARCH64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/aarch64/ubuntu20.04-mofed5-cuda12:3
  UBUNTU22_CUDA_12_AARCH64_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/aarch64/ubuntu22.04-mofed5-cuda12:3

resources:
  containers:
    # x86_64
    - container: centos7_cuda11_x86_64
      image: $(CENTOS7_CUDA_11_X86_64_IMAGE)
      options: $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(CENTOS7_CUDA_11_X86_64_IMAGE)
    - container: centos8_cuda11_x86_64
      image: $(CENTOS8_CUDA_11_X86_64_IMAGE)
      options: $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(CENTOS8_CUDA_11_X86_64_IMAGE)
    - container: ubuntu16_cuda11_x86_64
      image: $(UBUNTU16_CUDA_11_X86_64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU16_CUDA_11_X86_64_IMAGE)
    - container: ubuntu18_cuda11_x86_64
      image: $(UBUNTU18_CUDA_11_X86_64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU18_CUDA_11_X86_64_IMAGE)
    - container: ubuntu20_cuda11_x86_64
      image: $(UBUNTU20_CUDA_11_X86_64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU20_CUDA_11_X86_64_IMAGE)
    - container: ubuntu22_cuda11_x86_64
      image: $(UBUNTU22_CUDA_11_X86_64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU22_CUDA_11_X86_64_IMAGE)
    - container: centos7_cuda12_x86_64
      image: $(CENTOS7_CUDA_12_X86_64_IMAGE)
      options: $(DOCKER_OPT_VOLUMES)
    - container: ubuntu18_cuda12_x86_64
      image: $(UBUNTU18_CUDA_12_X86_64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU18_CUDA_12_X86_64_IMAGE)
    - container: ubuntu20_cuda12_x86_64
      image: $(UBUNTU20_CUDA_12_X86_64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU20_CUDA_12_X86_64_IMAGE)
    - container: ubuntu22_cuda12_x86_64
      image: $(UBUNTU22_CUDA_12_X86_64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU22_CUDA_12_X86_64_IMAGE)

    # aarch64
    - container: centos8_cuda11_aarch64
      image: $(CENTOS8_CUDA_11_AARCH64_IMAGE)
      options: $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(CENTOS8_CUDA_11_AARCH64_IMAGE)
    - container: ubuntu18_cuda11_aarch64
      image: $(UBUNTU18_CUDA_11_AARCH64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU18_CUDA_11_AARCH64_IMAGE)
    - container: ubuntu20_cuda11_aarch64
      image: $(UBUNTU20_CUDA_11_AARCH64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU20_CUDA_11_AARCH64_IMAGE)
    - container: ubuntu22_cuda11_aarch64
      image: $(UBUNTU22_CUDA_11_AARCH64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU22_CUDA_11_AARCH64_IMAGE)
    - container: ubuntu20_cuda12_aarch64
      image: $(UBUNTU20_CUDA_12_AARCH64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU20_CUDA_12_AARCH64_IMAGE)
    - container: ubuntu22_cuda12_aarch64
      image: $(UBUNTU22_CUDA_12_AARCH64_IMAGE)
      options: --env IMAGE_TAG=$(UBUNTU22_CUDA_12_AARCH64_IMAGE)

stages:
  - stage: Prepare
    jobs:
      - job: CheckRelease
        pool:
          name: MLNX
          demands:
          - ucx_docker
        steps:
          - checkout: self
            fetchDepth: 100
            clean: true
            retryCountOnTaskFailure: 5

          - bash: |
              set -eE
              source ./buildlib/az-helpers.sh
              set -x
              check_release_build $(Build.Reason) $(Build.SourceVersion) "AZP/RELEASE: "
            name: Result
            displayName: Check build condition


  - stage: GitHubDraft
    condition: eq(dependencies.Prepare.outputs['CheckRelease.Result.Launch'], 'True')
    dependsOn: Prepare
    jobs:
    - template: az-github-draft.yml
      parameters:
        arch: x86_64
        container: centos7_cuda11_x86_64
        demands: ucx_docker

    - template: az-github-draft.yml
      parameters:
        arch: aarch64
        container: centos8_cuda11_aarch64
        demands: ucx-arm64


  - stage: Build
    displayName: Build binary packages
    dependsOn:
      - Prepare
      - GitHubDraft
    condition: eq(dependencies.Prepare.outputs['CheckRelease.Result.Launch'], 'True')
    jobs:
      - template: az-distro-release.yml
        parameters:
          arch: x86_64
          demands: ucx_docker

      - template: az-distro-release.yml
        parameters:
          arch: aarch64
          demands: ucx-arm64

      - template: jucx/jucx-build.yml
        parameters:
          arch: amd64
          container: centos8_cuda11_x86_64
          demands: ucx_docker
          target: publish-release

      - template: jucx/jucx-build.yml
        parameters:
          arch: aarch64
          container: centos8_cuda11_aarch64
          demands: ucx-arm64
          target: publish-release
