# See https://aka.ms/yaml
# This pipeline to be run on tags creation

trigger:
  tags:
    include:
      - v*

resources:
  containers:
    - container: centos7
      image: rdmz-harbor.rdmz.labs.mlnx/ucx/centos7:4


stages:
  # Create an empty draft to avoid race condition in distro releases
  - stage: GitHubRelease
    variables:
      ${{ if eq(variables['Build.Reason'], 'ResourceTrigger') }}:
        artifact_name: ucx-${{ replace(variables['Build.SourceBranch'], 'refs/heads/', '') }}-centos7-mofed5.tar.bz2
      ${{ if eq(variables['Build.Reason'], 'IndividualCI') }}:
        artifact_name: ucx-${{ replace(variables['Build.SourceBranch'], 'refs/tags/', '') }}-centos7-mofed5.tar.bz2
      ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        artifact_name: ucx-pr$(System.PullRequest.PullRequestNumber)-centos7-mofed5.tar.bz2
    jobs:
      - job: Release
        displayName: Create release
        container: centos7
        pool:
          name: MLNX
          demands:
          - ucx_docker -equals yes
        steps:
        - checkout: self
          clean: true
          fetchDepth: 100
          path: "we/need/to/go/deeper"

        - bash: ./autogen.sh
          displayName: Setup autotools

        - bash: |
            set -eE
            gcc --version
            ./contrib/configure-release --with-java=no
          displayName: Configure

        - bash: |
            set -eEx
            cd pkg-build
            ../contrib/buildrpm.sh -s -t -b --noclean
            cd rpm-dist/`uname -m`
            tar -cjf "../../../${AZ_ARTIFACT_NAME}" *.rpm
            cd ../../..
            tar -tjf "${AZ_ARTIFACT_NAME}"
          displayName: Build RPM package
          env:
            AZ_ARTIFACT_NAME: $(artifact_name)

          - task: GithubRelease@0
            condition: eq(variables['Build.Reason'], 'IndividualCI')
            displayName: Upload artifacts
            inputs:
              githubConnection: release
              repositoryName: mellanox/ucx
              action: edit
              tag: $(Build.SourceBranchName)
              isDraft: true
              addChangeLog: false
              assetUploadMode: replace
              assets: "./$(artifact_name)"
