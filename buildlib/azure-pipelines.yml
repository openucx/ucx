# See https://aka.ms/yaml

trigger:
  - master
pr:
  - master

resources:
  containers:
    - container: centos7
      image: ucfconsort.azurecr.io/ucx/centos7:1
      endpoint: ucfconsort_registry
    - container: csmock
      image: ucfconsort.azurecr.io/ucx/csmock:latest
      endpoint: ucfconsort_registry
      options: --cap-add=SYS_ADMIN --security-opt apparmor:unconfine

stages:
  - stage: Build
    jobs:
      # Perform test builds on relevant distributions.
      - job: Distros
        displayName: Test Build for
        strategy:
          matrix:
            centos7:
              CONTAINER: centos7
              CONFIGURE_OPTS:
        container: $[ variables['CONTAINER'] ]
        steps:
          - bash: |
              ./autogen.sh
            displayName: Setup autotools

          - bash: |
              mkdir build && cd build
              ../configure $(CONFIGURE_OPTS)
            displayName: Configure

          - bash: |
               cd build
               gcc -v
               make -s -j `nproc`
            displayName: Build for $(CONTAINER)
  - stage: Checks
    jobs:
      - job: csmock
        displayName: csmock
        container: csmock
        steps:
          - bash: ./autogen.sh
            displayName: Setup autotools

          - bash: ./contrib/configure-release
            displayName: Configure

          - bash: ./contrib/buildrpm.sh -t -s
            displayName: Build srcrpm

          - bash: |
              csmock -t cppcheck,gcc,shellcheck,clang -o csmock.tar.xz \
                -r fedora-rawhide-x86_64 --use-host-cppcheck --print-defects \
                `ls rpm-dist/*.src.rpm`
            displayName: Run csmock

          - bash: |
              tar xJf csmock.tar.xz
              if [ -s csmock/scan-results.err ]; then
                cat csmock/scan-results.err
                false
              else
                echo "csmock is clean"
              fi
            displayName: Check if there are any errors
