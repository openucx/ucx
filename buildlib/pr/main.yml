variables:
  DOCKER_OPT_VOLUMES: -v /hpc/local:/hpc/local -v /auto/sw_tools:/auto/sw_tools
  DOCKER_OPT_IB: --ulimit memlock=-1:-1 --device=/dev/infiniband/ --net=host
  DOCKER_OPT_GPU: --gpus all --device=/dev/gdrdrv --ipc=host $(DOCKER_OPT_IB)
  DOCKER_OPT_ARGS: --cap-add=SYS_PTRACE
  CENTOS7_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/centos7:4
  CENTOS7_IB_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/centos7:5
  CENTOS7_CUDA11_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/centos7-mofed5.4-cuda11:1
  FEDORA_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/fedora33:2
  FEDORA34_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/fedora34:2
  COVERITY_RH7_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/coverity:mofed-5.1-2.3.8.0
  RHEL76_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/rhel7.6/builder:mofed-5.0-1.0.0.0
  RHEL76_MOFED47_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/rhel7.6/builder:mofed-4.7-1.0.0.1
  RHEL74_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/rhel7.4/builder:mofed-5.0-1.0.0.0
  RHEL72_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/rhel7.2/builder:mofed-5.0-1.0.0.0
  RHEL82_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/rhel8.2/builder:mofed-5.0-1.0.0.0
  RHEL90_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/rhel9.0/builder:mofed-5.6-0.5.0.0
  UBUNTU2004_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu20.04/builder:mofed-5.0-1.0.0.0
  UBUNTU2204_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu22.04/builder:mofed-5.7-0.2.3.0
  UBUNTU2204_IB_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu22.04/builder:mofed-5.7-0.2.3.0
  UBUNTU2210_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu22.10/builder:mofed-5.8-0.2.1.0
  UBUNTU1804_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu18.04/builder:mofed-5.0-1.0.0.0
  DEBIAN113_IMAGE: rdmz-harbor.rdmz.labs.mlnx/hpcx/x86_64/debian11.3/builder:mofed-5.8-3.0.7.0
  DEBIAN109_IMAGE: rdmz-harbor.rdmz.labs.mlnx/hpcx/x86_64/debian10.9/builder:mofed-5.8-3.0.7.0
  SLES15SP2_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/sles15sp2/builder:mofed-5.0-1.0.0.0
  SLES12SP5_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/sles12sp5/builder:mofed-5.0-1.0.0.0
  CENTOS7_CUDA_11_0_IMAGE: nvidia/cuda:11.0.3-devel-centos7
  CENTOS7_CUDA_11_1_IMAGE: nvidia/cuda:11.1.1-devel-centos7
  CENTOS7_CUDA_11_2_IMAGE: nvidia/cuda:11.2.2-devel-centos7
  CENTOS7_CUDA_11_3_IMAGE: nvidia/cuda:11.3.1-devel-centos7
  CENTOS7_CUDA_11_4_IMAGE: nvidia/cuda:11.4.3-devel-centos7
  UBI8_CUDA_11_5_IMAGE: nvidia/cuda:11.5.2-devel-ubi8
  UBI8_CUDA_11_6_IMAGE: nvidia/cuda:11.6.2-devel-ubi8
  UBUNTU18_CUDA_11_0_IMAGE: nvidia/cuda:11.0.3-devel-ubuntu18.04
  UBUNTU18_CUDA_11_1_IMAGE: nvidia/cuda:11.1.1-devel-ubuntu18.04
  UBUNTU18_CUDA_11_2_IMAGE: nvidia/cuda:11.2.2-devel-ubuntu18.04
  UBUNTU18_CUDA_11_3_IMAGE: nvidia/cuda:11.3.1-devel-ubuntu18.04
  UBUNTU18_CUDA_11_4_IMAGE: nvidia/cuda:11.4.3-devel-ubuntu18.04
  UBUNTU18_CUDA_11_5_IMAGE: nvidia/cuda:11.5.2-devel-ubuntu18.04
  UBUNTU18_CUDA_11_6_IMAGE: nvidia/cuda:11.6.2-devel-ubuntu18.04
  UBUNTU20_CUDA_11_0_IMAGE: nvidia/cuda:11.0.3-devel-ubuntu20.04
  UBUNTU20_CUDA_11_1_IMAGE: nvidia/cuda:11.1.1-devel-ubuntu20.04
  UBUNTU20_CUDA_11_2_IMAGE: nvidia/cuda:11.2.2-devel-ubuntu20.04
  UBUNTU20_CUDA_11_3_IMAGE: nvidia/cuda:11.3.1-devel-ubuntu20.04
  UBUNTU20_CUDA_11_4_IMAGE: nvidia/cuda:11.4.3-devel-ubuntu20.04
  UBUNTU20_CUDA_11_5_IMAGE: nvidia/cuda:11.5.2-devel-ubuntu20.04
  UBUNTU20_CUDA_11_6_IMAGE: nvidia/cuda:11.6.2-devel-ubuntu20.04
  CENTOS7_CUDA_12_0_IMAGE: nvidia/cuda:12.0.0-devel-centos7
  CENTOS7_CUDA_12_1_IMAGE: nvidia/cuda:12.1.0-devel-centos7
  UBUNTU18_CUDA_12_0_IMAGE: nvidia/cuda:12.0.0-devel-ubuntu18.04
  UBUNTU18_CUDA_12_1_IMAGE: nvidia/cuda:12.1.0-devel-ubuntu18.04
  UBUNTU20_CUDA_12_0_IMAGE: nvidia/cuda:12.0.0-devel-ubuntu20.04
  UBUNTU20_CUDA_12_1_IMAGE: nvidia/cuda:12.1.0-devel-ubuntu20.04
  UBUNTU22_CUDA_12_0_IMAGE: nvidia/cuda:12.0.0-devel-ubuntu22.04
  UBUNTU22_CUDA_12_1_IMAGE: nvidia/cuda:12.1.0-devel-ubuntu22.04
  CENTOS8_CUDA11_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/centos8-mofed5-cuda11:1
  CENTOS8_CUDA11_ASAN_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/centos8-mofed23-cuda11_asan:1
  UBUNTU16_CUDA11_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/ubuntu16.04-mofed5-cuda11:1
  UBUNTU18_CUDA11_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/ubuntu18.04-mofed5-cuda11:1
  UBUNTU20_CUDA11_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/ubuntu20.04-mofed5-cuda11:1
  UBUNTU2004_ROCM_5_4_0_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu2004:rocm_5_4_0
  UBUNTU22_CUDA12_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu22.04-mofed5-cuda12:3
  UBUNTU2204_ROCM_6_0_0_IMAGE: rdmz-harbor.rdmz.labs.mlnx/ucx/x86_64/ubuntu2204:rocm-6.0.0

resources:
  containers:
    - container: centos7
      image: $(CENTOS7_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(CENTOS7_IMAGE)
    - container: centos7_ib
      image: $(CENTOS7_IB_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_IB) --env IMAGE_TAG=$(CENTOS7_IB_IMAGE)
    - container: centos7_cuda11
      image: $(CENTOS7_CUDA11_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS7_CUDA11_IMAGE)
    - container: fedora
      image: $(FEDORA_IMAGE)
      options: $(DOCKER_OPT_ARGS) --env IMAGE_TAG=$(FEDORA_IMAGE)
    - container: fedora34
      image: $(FEDORA34_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(FEDORA34_IMAGE)
    - container: coverity_rh7
      image: $(COVERITY_RH7_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(COVERITY_RH7_IMAGE)
    - container: rhel76
      image: $(RHEL76_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(RHEL76_IMAGE)
    - container: rhel76_mofed47
      image: $(RHEL76_MOFED47_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(RHEL76_MOFED47_IMAGE)
    - container: rhel74
      image: $(RHEL74_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(RHEL74_IMAGE)
    - container: rhel72
      image: $(RHEL72_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(RHEL72_IMAGE)
    - container: rhel82
      image: $(RHEL82_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(RHEL82_IMAGE)
    - container: rhel90
      image: $(RHEL90_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(RHEL90_IMAGE)
    - container: ubuntu2004
      image: $(UBUNTU2004_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(UBUNTU2004_IMAGE)
    - container: ubuntu2204
      image: $(UBUNTU2204_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(UBUNTU2204_IMAGE)
    - container: ubuntu2204_ib
      image: $(UBUNTU2204_IB_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_IB) --env IMAGE_TAG=$(UBUNTU2204_IB_IMAGE)
    - container: ubuntu2210
      image: $(UBUNTU2210_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(UBUNTU2210_IMAGE)
    - container: ubuntu1804
      image: $(UBUNTU1804_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(UBUNTU1804_IMAGE)
    - container: debian113
      image: $(DEBIAN113_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(DEBIAN113_IMAGE)
    - container: debian109
      image: $(DEBIAN109_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(DEBIAN109_IMAGE)
    - container: sles15sp2
      image: $(SLES15SP2_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(SLES15SP2_IMAGE)
    - container: sles12sp5
      image: $(SLES12SP5_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(SLES12SP5_IMAGE)
    - container: centos7_cuda_11_0
      image: $(CENTOS7_CUDA_11_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS7_CUDA_11_0_IMAGE)
    - container: centos7_cuda_11_1
      image: $(CENTOS7_CUDA_11_1_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS7_CUDA_11_1_IMAGE)
    - container: centos7_cuda_11_2
      image: $(CENTOS7_CUDA_11_2_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS7_CUDA_11_2_IMAGE)
    - container: centos7_cuda_11_3
      image: $(CENTOS7_CUDA_11_3_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS7_CUDA_11_3_IMAGE)
    - container: centos7_cuda_11_4
      image: $(CENTOS7_CUDA_11_4_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS7_CUDA_11_4_IMAGE)
    - container: ubi8_cuda_11_5
      image: $(UBI8_CUDA_11_5_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBI8_CUDA_11_5_IMAGE)
    - container: ubi8_cuda_11_6
      image: $(UBI8_CUDA_11_6_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBI8_CUDA_11_6_IMAGE)
    - container: ubuntu18_cuda_11_0
      image: $(UBUNTU18_CUDA_11_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_11_0_IMAGE)
    - container: ubuntu18_cuda_11_1
      image: $(UBUNTU18_CUDA_11_1_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_11_1_IMAGE)
    - container: ubuntu18_cuda_11_2
      image: $(UBUNTU18_CUDA_11_2_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_11_2_IMAGE)
    - container: ubuntu18_cuda_11_3
      image: $(UBUNTU18_CUDA_11_3_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_11_3_IMAGE)
    - container: ubuntu18_cuda_11_4
      image: $(UBUNTU18_CUDA_11_4_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_11_4_IMAGE)
    - container: ubuntu18_cuda_11_5
      image: $(UBUNTU18_CUDA_11_5_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_11_5_IMAGE)
    - container: ubuntu18_cuda_11_6
      image: $(UBUNTU18_CUDA_11_6_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_11_6_IMAGE)
    - container: ubuntu20_cuda_11_0
      image: $(UBUNTU20_CUDA_11_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_11_0_IMAGE)
    - container: ubuntu20_cuda_11_1
      image: $(UBUNTU20_CUDA_11_1_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_11_1_IMAGE)
    - container: ubuntu20_cuda_11_2
      image: $(UBUNTU20_CUDA_11_2_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_11_2_IMAGE)
    - container: ubuntu20_cuda_11_3
      image: $(UBUNTU20_CUDA_11_3_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_11_3_IMAGE)
    - container: ubuntu20_cuda_11_4
      image: $(UBUNTU20_CUDA_11_4_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_11_4_IMAGE)
    - container: ubuntu20_cuda_11_5
      image: $(UBUNTU20_CUDA_11_5_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_11_5_IMAGE)
    - container: ubuntu20_cuda_11_6
      image: $(UBUNTU20_CUDA_11_6_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_11_6_IMAGE)
    - container: centos7_cuda_12_0
      image: $(CENTOS7_CUDA_12_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS7_CUDA_12_0_IMAGE)
    - container: centos7_cuda_12_1
      image: $(CENTOS7_CUDA_12_1_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS7_CUDA_12_1_IMAGE)
    - container: ubuntu18_cuda_12_0
      image: $(UBUNTU18_CUDA_12_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_12_0_IMAGE)
    - container: ubuntu18_cuda_12_1
      image: $(UBUNTU18_CUDA_12_1_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA_12_1_IMAGE)
    - container: ubuntu20_cuda_12_0
      image: $(UBUNTU20_CUDA_12_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_12_0_IMAGE)
    - container: ubuntu20_cuda_12_1
      image: $(UBUNTU20_CUDA_12_1_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA_12_1_IMAGE)
    - container: ubuntu22_cuda_12_0
      image: $(UBUNTU22_CUDA_12_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU22_CUDA_12_0_IMAGE)
    - container: ubuntu22_cuda_12_1
      image: $(UBUNTU22_CUDA_12_1_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU22_CUDA_12_1_IMAGE)
    - container: centos8_cuda11
      image: $(CENTOS8_CUDA11_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS8_CUDA11_IMAGE)
    - container: centos8_cuda11_asan
      image: $(CENTOS8_CUDA11_ASAN_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(CENTOS8_CUDA11_ASAN_IMAGE)
    - container: ubuntu16_cuda11
      image: $(UBUNTU16_CUDA11_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU16_CUDA11_IMAGE)
    - container: ubuntu18_cuda11
      image: $(UBUNTU18_CUDA11_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU18_CUDA11_IMAGE)
    - container: ubuntu20_cuda11
      image: $(UBUNTU20_CUDA11_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU20_CUDA11_IMAGE)
    - container: ubuntu2004_rocm_5_4_0
      image: $(UBUNTU2004_ROCM_5_4_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(UBUNTU2004_ROCM_5_4_0_IMAGE)
    - container: ubuntu22_cuda12
      image: $(UBUNTU22_CUDA12_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) $(DOCKER_OPT_GPU) --env IMAGE_TAG=$(UBUNTU22_CUDA12_IMAGE)
    - container: ubuntu2204_rocm_6_0_0
      image: $(UBUNTU2204_ROCM_6_0_0_IMAGE)
      options: $(DOCKER_OPT_ARGS) $(DOCKER_OPT_VOLUMES) --env IMAGE_TAG=$(UBUNTU2204_ROCM_6_0_0_IMAGE)

stages:
  - stage: Codestyle
    jobs:
    - template: codestyle.yml

  - stage: Static_check
    dependsOn: [Codestyle]
    jobs:
    - template: static_checks.yml

  - stage: Build
    dependsOn: [Static_check]
    jobs:
      - job: build_source
        pool:
          name: MLNX
          demands:
            - ucx_docker -equals yes
        strategy:
          matrix:
            rhel72:
              CONTAINER: rhel72
              IMAGE_TAG: $(RHEL72_IMAGE)
            rhel74:
              CONTAINER: rhel74
              IMAGE_TAG: $(RHEL74_IMAGE)
            rhel76:
              CONTAINER: rhel76
              IMAGE_TAG: $(RHEL76_IMAGE)
              long_test: yes
            rhel76_mofed47:
              CONTAINER: rhel76_mofed47
              IMAGE_TAG: $(RHEL76_MOFED47_IMAGE)
              long_test: yes
            ubuntu2004:
              CONTAINER: ubuntu2004
              IMAGE_TAG: $(UBUNTU2004_IMAGE)
              long_test: yes
              extra_modules: ""
            ubuntu1804:
              CONTAINER: ubuntu1804
              IMAGE_TAG: $(UBUNTU1804_IMAGE)
              extra_modules: ""
            ubuntu2204:
              CONTAINER: ubuntu2204
              IMAGE_TAG: $(UBUNTU2204_IMAGE)
            ubuntu2210:
              CONTAINER: ubuntu2210
              IMAGE_TAG: $(UBUNTU2210_IMAGE)
            debian113:
              CONTAINER: debian113
              IMAGE_TAG: $(DEBIAN113_IMAGE)
            debian109:
              CONTAINER: debian109
              IMAGE_TAG: $(DEBIAN109_IMAGE)
            sles15sp2:
              CONTAINER: sles15sp2
              IMAGE_TAG: $(SLES15SP2_IMAGE)
            rhel82:
              CONTAINER: rhel82
              IMAGE_TAG: $(RHEL82_IMAGE)
            rhel90:
              CONTAINER: rhel90
              IMAGE_TAG: $(RHEL90_IMAGE)
            fedora34:
              CONTAINER: fedora34
              IMAGE_TAG: $(FEDORA34_IMAGE)
              long_test: yes
            centos7:
              CONTAINER: centos7_ib
              IMAGE_TAG: $(CENTOS7_IMAGE)
            ubuntu2004_rocm:
              CONTAINER: ubuntu2004_rocm_5_4_0
              IMAGE_TAG: $(UBUNTU2004_ROCM_5_4_0_IMAGE)
            ubuntu2204_rocm:
              CONTAINER: ubuntu2204_rocm_6_0_0
              IMAGE_TAG: $(UBUNTU2204_ROCM_6_0_0_IMAGE)
        container: $[ variables['CONTAINER'] ]
        timeoutInMinutes: 340

        steps:
          - checkout: self
            clean: true
            fetchDepth: 100
            retryCountOnTaskFailure: 5

          - bash: |
              ./buildlib/tools/builds.sh
            displayName: Build
            env:
              BUILD_ID: "$(Build.BuildId)-$(Build.BuildNumber)"
              long_test: $(long_test)
              test_static: $(test_static)

  - stage: ucx_perftest_mad_rte
    dependsOn: [Static_check]
    displayName: ucx_perftest over MAD RTE
    lockBehavior: sequential
    variables:
      - group: concurrency_lock
    jobs:
    - template: mad_tests.yml

  - stage: WireCompat
    dependsOn: [Static_check]
    jobs:
    - template: wire_compat.yml
      parameters:
        name: althca
        demands: ucx_althca -equals yes
    - template: wire_compat.yml
      parameters:
        name: gpu
        demands: ucx_gpu -equals yes
        container: centos7_cuda11
        ucx_targets:
          ucx_1_15:
            ucx_tag: v1.15.x
          ucx_1_16:
            ucx_tag: v1.16.x
          ucx_1_17:
            ucx_tag: v1.17.x
          ucx_1_18:
            ucx_tag: v1.18.x
    - template: wire_compat.yml
      parameters:
        name: new
        demands: ucx_new -equals yes
    # Temporarily disable wire-compat tests on rain machines
    #- template: wire_compat.yml
    #  parameters:
    #    name: bond
    #    demands: ucx_iodemo -equals yes

  - stage: Coverity
    dependsOn: [Static_check]
    jobs:
      - template: coverity.yml
        parameters:
          demands: ucx_docker -equals yes
          container: coverity_rh7

  - stage: Tests
    dependsOn: [Static_check]
    jobs:
    - template: tests.yml
      parameters:
        name: althca
        demands: ucx_althca -equals yes
        test_perf: 0
    - template: tests.yml
      parameters:
        name: gpu
        demands: ucx_gpu -equals yes
        test_perf: 1
        container: centos7_cuda11
    - template: tests.yml
      parameters:
        name: new
        demands: ucx_new -equals yes
        test_perf: 1
    - template: tests.yml
      parameters:
        name: roce
        demands: ucx_roce -equals yes
        test_perf: 0
    - template: tests.yml
      parameters:
        name: roce_proto_disable
        demands: ucx_roce -equals yes
        test_perf: 0
        proto_enable: no
    - template: tests.yml
      parameters:
        name: BlueField
        demands: ucx_bf -equals yes
        run_tests: yes
        test_perf: 0

  - stage: Namespace_Tests
    dependsOn: [Static_check]
    jobs:
    - template: namespace_tests.yml
      parameters:
        name: new_namespace
        demands: ucx_new -equals yes

  - stage: io_demo
    dependsOn: [Static_check]
    jobs:
    - template: io_demo/io-demo.yml

  - stage: jucx
    dependsOn: [Static_check]
    jobs:
      - template: ../jucx/jucx-test.yml
        parameters:
          arch: amd64
          name: gpu
          demands: ucx_gpu

      - template: ../jucx/jucx-test.yml
        parameters:
          arch: aarch64
          demands: ucx-arm64

  - stage: go
    dependsOn: [Static_check]
    jobs:
      - template: go/go-test.yml
        parameters:
          name: new
          demands: ucx_new -equals yes
      - template: go/go-test.yml
        parameters:
            name: gpu
            demands: ucx_gpu -equals yes

  - stage: Build_Static
    dependsOn: [Static_check]
    jobs:
      - job: build_source
        pool:
          name: MLNX
          demands:
            - ucx_docker -equals yes
        strategy:
          matrix:
            centos7:
              CONTAINER: centos7_ib
              extra_modules: ucx-ib ucx-cma ucx-rdmacm ucx-ib-mlx5
              extra_tls: dc_mlx5 rc_mlx5 ud_mlx5 rc_verbs ud_verbs cma
              run_tls: ib rc rc_v rc_x dc dc_x ud ud_v ud_x shm sm
              IMAGE_TAG: $(CENTOS7_IMAGE)
            ubuntu2004:
              CONTAINER: ubuntu2004
              extra_modules: ""
              extra_tls: ""
              run_tls: ""
              IMAGE_TAG: $(UBUNTU2004_IMAGE)
            ubuntu1804:
              CONTAINER: ubuntu1804
              extra_modules: ""
              extra_tls: ""
              run_tls: ""
              IMAGE_TAG: $(UBUNTU1804_IMAGE)
        container: $[ variables['CONTAINER'] ]
        timeoutInMinutes: 340

        steps:
          - checkout: self
            clean: true
            fetchDepth: 100
            retryCountOnTaskFailure: 5

          - bash: |
              ./buildlib/tools/build_static.sh
            displayName: Build
            env:
              EXTRA_TLS: $(extra_tls)
              RUN_TLS: $(run_tls)
              EXTRA_MODULES: $(extra_modules)


  - stage: Cuda
    dependsOn: [Static_check]
    jobs:
      - template: cuda/cuda.yml


  - stage: AddressSanitizer
    dependsOn: [Static_check]
    jobs:
    - template: tests.yml
      parameters:
        name: gpu
        demands: ucx_gpu -equals yes
        test_perf: 0
        container: centos8_cuda11_asan
        asan_check: yes
    - template: tests.yml
      parameters:
        name: new
        demands: ucx_new -equals yes
        test_perf: 0
        container: ubuntu2204_ib
        asan_check: yes
    - template: tests.yml
      parameters:
        name: roce
        demands: ucx_roce -equals yes
        test_perf: 0
        container: ubuntu2204_ib
        asan_check: yes
    - template: tests.yml
      parameters:
        name: roce_proto_disable
        demands: ucx_roce -equals yes
        test_perf: 0
        proto_enable: no
        container: ubuntu2204_ib
        asan_check: yes
    - template: tests.yml
      parameters:
        name: BlueField
        demands: ucx_bf -equals yes
        test_perf: 0
        asan_check: yes


#  - stage: Cuda_compatible
#    dependsOn: [Static_check]
#    jobs:
#    - template: cuda/cuda_compatible.yml
