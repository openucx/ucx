# Jenkins Job Builder (JJB) configuration for UCX project
# NOTE: This file is not applied automatically. DevOps applies it to Jenkins.
#
# Requires: /etc/jenkins_jobs/ucx-defaults.yaml (site-specific configuration)
# Deploy:   jenkins-jobs test /etc/jenkins_jobs/ucx-defaults.yaml:<this-file>
#
# Each job is triggered independently by GitLab and reports its own status.

- job-template:
    name: "{jjb_proj}"
    defaults: global
    jjb_branch: "master"
    jjb_folder: "UCX"
    jjb_jenkinsfile: ".ci/jenkins/Jenkinsfile"
    jjb_git_auth_id: "jenkins-git-ssh"
    folder: "{jjb_folder}"
    project-type: pipeline
    disabled: false
    properties:
      - gitlab:
          connection: gitlab-master
      - build-discarder:
          days-to-keep: 14
          num-to-keep: 1000
      - inject:
          keep-system-variables: true
          properties-content: |
            jjb_proj={jjb_proj}
    description: "{jjb_description}"
    concurrent: true
    sandbox: true
    triggers:
      - gitlab:
          trigger-push: false                     # Avoid duplicate builds
          trigger-merge-request: true             # Run when an MR is opened
          trigger-open-merge-request-push: source # Run when commits are pushed to an open MR
          branch-filter-type: All
          cancel-pending-builds-on-update: true
    parameters:
      - string:
          name: "sha1"
          default: "{jjb_branch}"
          description: "Ref/commit to build (usually set by GitLab webhook)"
      - string:
          name: "conf_file"
          default: "{jjb_conf_file}"
          description: "Matrix config file"
      - bool:
          name: "build_dockers"
          default: false
          description: "Force rebuild docker containers (if supported)"
      - string:
          name: "DEBUG"
          default: 0
          description: "Enable debug prints and traces, valid values are 0-9"
    pipeline-scm:
      scm:
        - git:
            url: "{jjb_git}"
            credentials-id: "{jjb_git_auth_id}"
            branches: [ '$gitlabSourceBranch', '$gitlabBranch', '$sha1' ]
            shallow-clone: false
            do-not-fetch-tags: false
            refspec: "+refs/heads/*:refs/remotes/origin/* +refs/tags/*:refs/remotes/origin/tags/* +refs/merge-requests/*/head:refs/remotes/origin/mr/* +refs/merge-requests/*/merge:refs/remotes/origin/mr-merge/*"
      script-path: "{jjb_jenkinsfile}"

- project:
    name: ucx-codestyle
    jjb_proj: "ucx-codestyle"
    jjb_conf_file: ".ci/pipeline/codestyle_matrix.yaml"
    jjb_description: "UCX Codestyle checks (commit titles, spelling). Do NOT edit via Web GUI!"
    jobs:
      - "{jjb_proj}"

- project:
    name: ucx-static-checks
    jjb_proj: "ucx-static-checks"
    jjb_conf_file: ".ci/pipeline/static_checks_matrix.yaml"
    jjb_description: "UCX Static checks (cppcheck, clang-analyzer). Do NOT edit via Web GUI!"
    jobs:
      - "{jjb_proj}"

- project:
    name: ucx-coverity
    jjb_proj: "ucx-coverity"
    jjb_conf_file: ".ci/pipeline/coverity_matrix.yaml"
    jjb_description: "UCX Coverity static analysis. Do NOT edit via Web GUI!"
    jobs:
      - "{jjb_proj}"

- project:
    name: ucx-build
    jjb_proj: "ucx-build"
    jjb_conf_file: ".ci/pipeline/build_matrix.yaml"
    jjb_description: "UCX Build job. Do NOT edit via Web GUI!"
    jobs:
      - "{jjb_proj}"

- project:
    name: ucx-build-static
    jjb_proj: "ucx-build-static"
    jjb_conf_file: ".ci/pipeline/build_static_matrix.yaml"
    jjb_description: "UCX Static library build and test. Do NOT edit via Web GUI!"
    jobs:
      - "{jjb_proj}"
