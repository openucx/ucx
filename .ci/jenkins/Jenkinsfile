#!/usr/bin/groovy

/**
 * Copyright (c) NVIDIA CORPORATION & AFFILIATES, 2026. ALL RIGHTS RESERVED.
 * See file LICENSE for terms.
 */

import hudson.model.TaskListener

@Library('github.com/Mellanox/ci-demo@master')
def matrix = new com.mellanox.cicd.Matrix()

// Reports per-job status to GitLab. JOB_BASE_NAME is set by Jenkins.
def statusName = env.JOB_BASE_NAME

// Abort previous running builds of the SAME merge request only.
def currentMrIid = env.gitlabMergeRequestIid
if (currentMrIid) {
  try {
    def job = Jenkins.instance.getItemByFullName(env.JOB_NAME)
    job.builds.findAll { b ->
      b.isBuilding() && b.number < currentBuild.number
    }.each { b ->
      try {
        def bEnv = b.getEnvironment(TaskListener.NULL)
        def mrIid = bEnv?.get('gitlabMergeRequestIid')
        if (mrIid == currentMrIid) {
          echo "Aborting previous build #${b.number} for same MR !${mrIid}"
          b.doStop()
        }
      } catch (Exception e) {
        echo "Could not check build #${b.number}: ${e.message}"
      }
    }
  } catch (Exception e) {
    echo "Could not abort previous builds: ${e.message}"
  }
}

gitlabCommitStatus(name: statusName) {
  matrix.main()
}
