<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UCX: ucp_hello_world.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="UCX_Logo_80x80.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UCX
   &#160;<span id="projectnumber">1.11</span>
   </div>
   <div id="projectbrief">Unified Communication X</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ucp_hello_world_8c-example.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ucp_hello_world.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>UCP hello world client / server example utility.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#ifndef HAVE_CONFIG_H</span></div><div class="line"><span class="preprocessor">#  define HAVE_CONFIG_H </span><span class="comment">/* Force using config.h, so test would fail if header</span></div><div class="line"><span class="comment">                           actually tries to use it */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * UCP hello world client / server example utility</span></div><div class="line"><span class="comment"> * -----------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Server side:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *    ./ucp_hello_world</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Client side:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *    ./ucp_hello_world -n &lt;server host name&gt;</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Notes:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *    - Client acquires Server UCX address via TCP socket</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *    Ilya Nelkenbaum &lt;ilya@nelkenbaum.com&gt;</span></div><div class="line"><span class="comment"> *    Sergey Shalnov &lt;sergeysh@mellanox.com&gt; 7-June-2016</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;hello_world_util.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;ucp/api/ucp.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;sys/socket.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/epoll.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;netinet/in.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;netdb.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span>  <span class="comment">/* getopt */</span></div><div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span> <span class="comment">/* pthread_self */</span></div><div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span>   <span class="comment">/* errno */</span></div><div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span>  <span class="comment">/* raise */</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span>msg {</div><div class="line">    uint64_t        data_len;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span>ucx_context {</div><div class="line">    <span class="keywordtype">int</span>             completed;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">enum</span> ucp_test_mode_t {</div><div class="line">    TEST_MODE_PROBE,</div><div class="line">    TEST_MODE_WAIT,</div><div class="line">    TEST_MODE_EVENTFD</div><div class="line">} ucp_test_mode = TEST_MODE_PROBE;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div><div class="line">    FAILURE_MODE_NONE,</div><div class="line">    FAILURE_MODE_SEND,      <span class="comment">/* fail send operation on server */</span></div><div class="line">    FAILURE_MODE_RECV,      <span class="comment">/* fail receive operation on client */</span></div><div class="line">    FAILURE_MODE_KEEPALIVE  <span class="comment">/* fail without communication on client */</span></div><div class="line">} failure_mode_t;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>err_handling {</div><div class="line">    <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga7c69a28724d5ae3e49490e23e64df167">ucp_err_handling_mode_t</a> ucp_err_mode;</div><div class="line">    failure_mode_t          failure_mode;</div><div class="line">} err_handling_opt;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> ep_status   = <a name="a0"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line"><span class="keyword">static</span> uint16_t server_port     = 13337;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">long</span> test_string_length  = 16;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group___u_c_p___c_o_m_m.html#ga55df42689ef1f5621eae4d1ffb16856e">ucp_tag_t</a> tag      = 0x1337a880u;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group___u_c_p___c_o_m_m.html#ga55df42689ef1f5621eae4d1ffb16856e">ucp_tag_t</a> tag_mask = UINT64_MAX;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *addr_msg_str = <span class="stringliteral">&quot;UCX address message&quot;</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *data_msg_str = <span class="stringliteral">&quot;UCX data message&quot;</span>;</div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga7d24d2759c1375bf4d2d639e3b701956">ucp_address_t</a> *local_addr;</div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga7d24d2759c1375bf4d2d639e3b701956">ucp_address_t</a> *peer_addr;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">size_t</span> local_addr_len;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">size_t</span> peer_addr_len;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> parse_cmd(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * <span class="keyword">const</span> argv[], <span class="keywordtype">char</span> **server_name);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> set_msg_data_len(<span class="keyword">struct</span> msg *msg, uint64_t data_len)</div><div class="line">{</div><div class="line">    mem_type_memcpy(&amp;msg-&gt;data_len, &amp;data_len, <span class="keyword">sizeof</span>(data_len));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> request_init(<span class="keywordtype">void</span> *request)</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>ucx_context *contex = (<span class="keyword">struct </span>ucx_context *)request;</div><div class="line"></div><div class="line">    contex-&gt;completed = 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> send_handler(<span class="keywordtype">void</span> *request, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status, <span class="keywordtype">void</span> *ctx)</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>ucx_context *context = (<span class="keyword">struct </span>ucx_context *)request;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *str             = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)ctx;</div><div class="line"></div><div class="line">    context-&gt;completed = 1;</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;[0x%x] send handler called for \&quot;%s\&quot; with status %d (%s)\n&quot;</span>,</div><div class="line">           (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)pthread_self(), str, status,</div><div class="line">           ucs_status_string(status));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> failure_handler(<span class="keywordtype">void</span> *arg, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> *arg_status = (<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> *)arg;</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;[0x%x] failure handler called with status %d (%s)\n&quot;</span>,</div><div class="line">           (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)pthread_self(), status, ucs_status_string(status));</div><div class="line"></div><div class="line">    *arg_status = status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> recv_handler(<span class="keywordtype">void</span> *request, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status,</div><div class="line">                        <a name="_a1"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__tag__recv__info">ucp_tag_recv_info_t</a> *info)</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>ucx_context *context = (<span class="keyword">struct </span>ucx_context *)request;</div><div class="line"></div><div class="line">    context-&gt;completed = 1;</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;[0x%x] receive handler called with status %d (%s), length %lu\n&quot;</span>,</div><div class="line">           (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)pthread_self(), status, ucs_status_string(status),</div><div class="line">           info-&gt;<a name="a2"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a6fd83122b93c677e702dc37b39e8351b">length</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> ucx_wait(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <span class="keyword">struct</span> ucx_context *request,</div><div class="line">                             <span class="keyword">const</span> <span class="keywordtype">char</span> *op_str, <span class="keyword">const</span> <span class="keywordtype">char</span> *data_str)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (UCS_PTR_IS_ERR(request)) {</div><div class="line">        status = UCS_PTR_STATUS(request);</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UCS_PTR_IS_PTR(request)) {</div><div class="line">        <span class="keywordflow">while</span> (!request-&gt;completed) {</div><div class="line">            <a name="a3"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line">        }</div><div class="line"></div><div class="line">        request-&gt;completed = 0;</div><div class="line">        status             = <a name="a4"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gae082ad7af428645ebe6e469d3d06a757">ucp_request_check_status</a>(request);</div><div class="line">        <a name="a5"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#gaabf569a298946627fbc8d66814c35e68">ucp_request_release</a>(request);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;unable to %s %s (%s)\n&quot;</span>, op_str, data_str,</div><div class="line">                ucs_status_string(status));</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        printf(<span class="stringliteral">&quot;finish to %s %s\n&quot;</span>, op_str, data_str);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> test_poll_wait(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> err            = 0;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> ret   = <a name="a6"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1bbd2445646883a1ef758fe2ef75e586">UCS_ERR_NO_MESSAGE</a>;</div><div class="line">    <span class="keywordtype">int</span> epoll_fd_local = 0;</div><div class="line">    <span class="keywordtype">int</span> epoll_fd       = 0;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <span class="keyword">struct </span>epoll_event ev;</div><div class="line">    ev.data.u64        = 0;</div><div class="line"></div><div class="line">    status = <a name="a7"></a><a class="code" href="group___u_c_p___w_a_k_e_u_p.html#gadf849649110fa338fd891548198a578b">ucp_worker_get_efd</a>(ucp_worker, &amp;epoll_fd);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;ucp_worker_get_efd&quot;</span>, err);</div><div class="line"></div><div class="line">    <span class="comment">/* It is recommended to copy original fd */</span></div><div class="line">    epoll_fd_local = epoll_create(1);</div><div class="line"></div><div class="line">    ev.data.fd = epoll_fd;</div><div class="line">    ev.events = EPOLLIN;</div><div class="line">    err = epoll_ctl(epoll_fd_local, EPOLL_CTL_ADD, epoll_fd, &amp;ev);</div><div class="line">    CHKERR_JUMP(err &lt; 0, <span class="stringliteral">&quot;add original socket to the new epoll\n&quot;</span>, err_fd);</div><div class="line"></div><div class="line">    <span class="comment">/* Need to prepare ucp_worker before epoll_wait */</span></div><div class="line">    status = <a name="a8"></a><a class="code" href="group___u_c_p___w_a_k_e_u_p.html#gadce97937294aae0f5f599d58d68904d6">ucp_worker_arm</a>(ucp_worker);</div><div class="line">    <span class="keywordflow">if</span> (status == <a name="a9"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a331d8719f76965a4514684c570110105">UCS_ERR_BUSY</a>) { <span class="comment">/* some events are arrived already */</span></div><div class="line">        ret = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">        <span class="keywordflow">goto</span> err_fd;</div><div class="line">    }</div><div class="line">    CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;ucp_worker_arm\n&quot;</span>, err_fd);</div><div class="line"></div><div class="line">    <span class="keywordflow">do</span> {</div><div class="line">        err = epoll_wait(epoll_fd_local, &amp;ev, 1, -1);</div><div class="line">    } <span class="keywordflow">while</span> ((err == -1) &amp;&amp; (errno == EINTR));</div><div class="line"></div><div class="line">    ret = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line"></div><div class="line">err_fd:</div><div class="line">    close(epoll_fd_local);</div><div class="line"></div><div class="line">err:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> run_ucx_client(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker)</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>msg *msg = NULL;</div><div class="line">    <span class="keywordtype">size_t</span> msg_len  = 0;</div><div class="line">    <span class="keywordtype">int</span> ret         = -1;</div><div class="line">    <a name="_a10"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__request__param__t">ucp_request_param_t</a> send_param;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__tag__recv__info">ucp_tag_recv_info_t</a> info_tag;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_m_m.html#ga6a8b5741a4e66d7e890d31ef7cbf88ec">ucp_tag_message_h</a> msg_tag;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> server_ep;</div><div class="line">    <a name="_a11"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#structucp__ep__params">ucp_ep_params_t</a> ep_params;</div><div class="line">    <span class="keyword">struct </span>ucx_context *request;</div><div class="line">    <span class="keywordtype">char</span> *str;</div><div class="line"></div><div class="line">    <span class="comment">/* Send client UCX address to server */</span></div><div class="line">    ep_params.<a name="a12"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ab7b3f3ba1d402a621b8ea708dcf2387b">field_mask</a>      = <a name="a13"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60ae1c4a9617dea28b56c486ac357299f4c">UCP_EP_PARAM_FIELD_REMOTE_ADDRESS</a> |</div><div class="line">                                <a name="a14"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60a1b0e70c12efabe6a2cab3c9bc66db340">UCP_EP_PARAM_FIELD_ERR_HANDLING_MODE</a> |</div><div class="line">                                <a name="a15"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60adc6619f5e4bf3f68190f918ee064036d">UCP_EP_PARAM_FIELD_ERR_HANDLER</a> |</div><div class="line">                                <a name="a16"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60afc6cbbfabd368438e5d6afd36f389d1b">UCP_EP_PARAM_FIELD_USER_DATA</a>;</div><div class="line">    ep_params.<a name="a17"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#a8cf5c1599022ccdea5a6d1c97ced3627">address</a>         = peer_addr;</div><div class="line">    ep_params.<a name="a18"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#a50ce29893509695caa5b70ab4525a4d6">err_mode</a>        = err_handling_opt.ucp_err_mode;</div><div class="line">    ep_params.<a name="a19"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aaf329de9e2b45311099cee8c9df43a20">err_handler</a>.<a name="a20"></a><a class="code" href="group___u_c_p___c_o_m_m.html#a0bf3f446a1821a62dd3a300584792e33">cb</a>  = failure_handler;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aaf329de9e2b45311099cee8c9df43a20">err_handler</a>.<a name="a21"></a><a class="code" href="group___u_c_p___c_o_m_m.html#a7e49e1843e1adab5561e5fc2b2e1afb1">arg</a> = NULL;</div><div class="line">    ep_params.<a name="a22"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#adaf49e16ee05400f715f432e442336cb">user_data</a>       = &amp;ep_status;</div><div class="line"></div><div class="line">    status = <a name="a23"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga6cc5ffb2ba1b0ccd510848de0a779f7b">ucp_ep_create</a>(ucp_worker, &amp;ep_params, &amp;server_ep);</div><div class="line">    CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;ucp_ep_create\n&quot;</span>, err);</div><div class="line"></div><div class="line">    msg_len = <span class="keyword">sizeof</span>(*msg) + local_addr_len;</div><div class="line">    msg     = malloc(msg_len);</div><div class="line">    CHKERR_JUMP(msg == NULL, <span class="stringliteral">&quot;allocate memory\n&quot;</span>, err_ep);</div><div class="line">    memset(msg, 0, msg_len);</div><div class="line"></div><div class="line">    msg-&gt;data_len = local_addr_len;</div><div class="line">    memcpy(msg + 1, local_addr, local_addr_len);</div><div class="line"></div><div class="line">    send_param.<a name="a24"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a> = <a name="a25"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a73e3a6e8b96b37ec1b0764e67dd13602">UCP_OP_ATTR_FIELD_CALLBACK</a> |</div><div class="line">                              <a name="a26"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610af6f932f15331fe7c9efacbfe2578e5ec">UCP_OP_ATTR_FIELD_USER_DATA</a>;</div><div class="line">    send_param.<a name="a27"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.send      = send_handler;</div><div class="line">    send_param.<a name="a28"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#aa9092d65a2e4e55368ca4f88775c190b">user_data</a>    = (<span class="keywordtype">void</span>*)addr_msg_str;</div><div class="line">    request                 = <a name="a29"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ga8323878b60f426c630d4ff8996ede3cc">ucp_tag_send_nbx</a>(server_ep, msg, msg_len, tag,</div><div class="line">                                               &amp;send_param);</div><div class="line">    status                  = ucx_wait(ucp_worker, request, <span class="stringliteral">&quot;send&quot;</span>,</div><div class="line">                                       addr_msg_str);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        free(msg);</div><div class="line">        <span class="keywordflow">goto</span> err_ep;</div><div class="line">    }</div><div class="line"></div><div class="line">    free(msg);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (err_handling_opt.failure_mode == FAILURE_MODE_RECV) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Emulating failure before receive operation on client side\n&quot;</span>);</div><div class="line">        <span class="keyword">raise</span>(SIGKILL);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Receive test string from server */</span></div><div class="line">    <span class="keywordflow">for</span> (;;) {</div><div class="line">        CHKERR_JUMP(ep_status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;receive data: EP disconnected\n&quot;</span>, err_ep);</div><div class="line">        <span class="comment">/* Probing incoming events in non-block mode */</span></div><div class="line">        msg_tag = <a name="a30"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ga41668f468dc37a7634116b8210815f22">ucp_tag_probe_nb</a>(ucp_worker, tag, tag_mask, 1, &amp;info_tag);</div><div class="line">        <span class="keywordflow">if</span> (msg_tag != NULL) {</div><div class="line">            <span class="comment">/* Message arrived */</span></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker)) {</div><div class="line">            <span class="comment">/* Some events were polled; try again without going to sleep */</span></div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* If we got here, ucp_worker_progress() returned 0, so we can sleep.</span></div><div class="line"><span class="comment">         * Following blocked methods used to polling internal file descriptor</span></div><div class="line"><span class="comment">         * to make CPU idle and don&#39;t spin loop</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keywordflow">if</span> (ucp_test_mode == TEST_MODE_WAIT) {</div><div class="line">            <span class="comment">/* Polling incoming events*/</span></div><div class="line">            status = <a name="a31"></a><a class="code" href="group___u_c_p___w_a_k_e_u_p.html#gaa6d1fba4d8a2525b74174a8c344ae9aa">ucp_worker_wait</a>(ucp_worker);</div><div class="line">            CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;ucp_worker_wait\n&quot;</span>, err_ep);</div><div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ucp_test_mode == TEST_MODE_EVENTFD) {</div><div class="line">            status = test_poll_wait(ucp_worker);</div><div class="line">            CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;test_poll_wait\n&quot;</span>, err_ep);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="keywordflow">if</span> (err_handling_opt.failure_mode == FAILURE_MODE_KEEPALIVE) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Emulating unexpected failure after receive completion &quot;</span></div><div class="line">                        <span class="stringliteral">&quot;on client side, server should detect error by &quot;</span></div><div class="line">                        <span class="stringliteral">&quot;keepalive mechanism\n&quot;</span>);</div><div class="line">        <span class="keyword">raise</span>(SIGKILL);</div><div class="line">    }</div><div class="line"></div><div class="line">    msg = mem_type_malloc(info_tag.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a6fd83122b93c677e702dc37b39e8351b">length</a>);</div><div class="line">    CHKERR_JUMP(msg == NULL, <span class="stringliteral">&quot;allocate memory\n&quot;</span>, err_ep);</div><div class="line"></div><div class="line">    request = <a name="a32"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gac335b3ae4c9577728d9c0f2ecd44c084">ucp_tag_msg_recv_nb</a>(ucp_worker, msg, info_tag.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a6fd83122b93c677e702dc37b39e8351b">length</a>,</div><div class="line">                                  <a name="a33"></a><a class="code" href="group___u_c_p___d_a_t_a_t_y_p_e.html#ga9a56fc4636094bab740d77f7df70c2b5">ucp_dt_make_contig</a>(1), msg_tag,</div><div class="line">                                  recv_handler);</div><div class="line">    status  = ucx_wait(ucp_worker, request, <span class="stringliteral">&quot;receive&quot;</span>, data_msg_str);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        mem_type_free(msg);</div><div class="line">        <span class="keywordflow">goto</span> err_ep;</div><div class="line">    }</div><div class="line"></div><div class="line">    str = calloc(1, test_string_length);</div><div class="line">    <span class="keywordflow">if</span> (str == NULL) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Memory allocation failed\n&quot;</span>);</div><div class="line">        ret = -1;</div><div class="line">        <span class="keywordflow">goto</span> err_msg;</div><div class="line">    }</div><div class="line"></div><div class="line">    mem_type_memcpy(str, msg + 1, test_string_length);</div><div class="line">    printf(<span class="stringliteral">&quot;\n\n----- UCP TEST SUCCESS ----\n\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;%s&quot;</span>, str);</div><div class="line">    printf(<span class="stringliteral">&quot;\n\n---------------------------\n\n&quot;</span>);</div><div class="line">    free(str);</div><div class="line">    ret = 0;</div><div class="line"></div><div class="line">err_msg:</div><div class="line">    mem_type_free(msg);</div><div class="line">err_ep:</div><div class="line">    <a name="a34"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#gac63b3fe87c001dd965ca42943ea04bb1">ucp_ep_destroy</a>(server_ep);</div><div class="line">err:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> flush_callback(<span class="keywordtype">void</span> *request, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status, <span class="keywordtype">void</span> *user_data)</div><div class="line">{</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> flush_ep(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> worker, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__request__param__t">ucp_request_param_t</a> param;</div><div class="line">    <span class="keywordtype">void</span> *request;</div><div class="line"></div><div class="line">    param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a> = <a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a73e3a6e8b96b37ec1b0764e67dd13602">UCP_OP_ATTR_FIELD_CALLBACK</a>;</div><div class="line">    param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.send      = flush_callback;</div><div class="line">    request            = <a name="a35"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga28d61bf53320bd0f5d741147447251a4">ucp_ep_flush_nbx</a>(ep, &amp;param);</div><div class="line">    <span class="keywordflow">if</span> (request == NULL) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UCS_PTR_IS_ERR(request)) {</div><div class="line">        <span class="keywordflow">return</span> UCS_PTR_STATUS(request);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">        <span class="keywordflow">do</span> {</div><div class="line">            <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(worker);</div><div class="line">            status = <a class="code" href="group___u_c_p___c_o_m_m.html#gae082ad7af428645ebe6e469d3d06a757">ucp_request_check_status</a>(request);</div><div class="line">        } <span class="keywordflow">while</span> (status == <a name="a36"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a77aa02620851779729e4ad6ceb41f84a">UCS_INPROGRESS</a>);</div><div class="line">        <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#gaabf569a298946627fbc8d66814c35e68">ucp_request_release</a>(request);</div><div class="line">        <span class="keywordflow">return</span> status;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> run_ucx_server(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker)</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>msg *msg             = NULL;</div><div class="line">    <span class="keyword">struct </span>ucx_context *request = NULL;</div><div class="line">    <span class="keywordtype">size_t</span> msg_len              = 0;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__request__param__t">ucp_request_param_t</a> send_param;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__tag__recv__info">ucp_tag_recv_info_t</a> info_tag;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_m_m.html#ga6a8b5741a4e66d7e890d31ef7cbf88ec">ucp_tag_message_h</a> msg_tag;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> client_ep;</div><div class="line">    <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#structucp__ep__params">ucp_ep_params_t</a> ep_params;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line"></div><div class="line">    <span class="comment">/* Receive client UCX address */</span></div><div class="line">    <span class="keywordflow">do</span> {</div><div class="line">        <span class="comment">/* Progressing before probe to update the state */</span></div><div class="line">        <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line"></div><div class="line">        <span class="comment">/* Probing incoming events in non-block mode */</span></div><div class="line">        msg_tag = <a class="code" href="group___u_c_p___c_o_m_m.html#ga41668f468dc37a7634116b8210815f22">ucp_tag_probe_nb</a>(ucp_worker, tag, tag_mask, 1, &amp;info_tag);</div><div class="line">    } <span class="keywordflow">while</span> (msg_tag == NULL);</div><div class="line"></div><div class="line">    msg = malloc(info_tag.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a6fd83122b93c677e702dc37b39e8351b">length</a>);</div><div class="line">    CHKERR_ACTION(msg == NULL, <span class="stringliteral">&quot;allocate memory\n&quot;</span>, ret = -1; <span class="keywordflow">goto</span> err);</div><div class="line">    request = <a class="code" href="group___u_c_p___c_o_m_m.html#gac335b3ae4c9577728d9c0f2ecd44c084">ucp_tag_msg_recv_nb</a>(ucp_worker, msg, info_tag.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a6fd83122b93c677e702dc37b39e8351b">length</a>,</div><div class="line">                                  <a class="code" href="group___u_c_p___d_a_t_a_t_y_p_e.html#ga9a56fc4636094bab740d77f7df70c2b5">ucp_dt_make_contig</a>(1), msg_tag, recv_handler);</div><div class="line">    status  = ucx_wait(ucp_worker, request, <span class="stringliteral">&quot;receive&quot;</span>, addr_msg_str);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        free(msg);</div><div class="line">        ret = -1;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (err_handling_opt.failure_mode == FAILURE_MODE_SEND) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Emulating unexpected failure on server side, client &quot;</span></div><div class="line">                        <span class="stringliteral">&quot;should detect error by keepalive mechanism\n&quot;</span>);</div><div class="line">        free(msg);</div><div class="line">        <span class="keyword">raise</span>(SIGKILL);</div><div class="line">        exit(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    peer_addr_len = msg-&gt;data_len;</div><div class="line">    peer_addr     = malloc(peer_addr_len);</div><div class="line">    <span class="keywordflow">if</span> (peer_addr == NULL) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;unable to allocate memory for peer address\n&quot;</span>);</div><div class="line">        free(msg);</div><div class="line">        ret = -1;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    memcpy(peer_addr, msg + 1, peer_addr_len);</div><div class="line"></div><div class="line">    free(msg);</div><div class="line"></div><div class="line">    <span class="comment">/* Send test string to client */</span></div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ab7b3f3ba1d402a621b8ea708dcf2387b">field_mask</a>      = <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60ae1c4a9617dea28b56c486ac357299f4c">UCP_EP_PARAM_FIELD_REMOTE_ADDRESS</a> |</div><div class="line">                                <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60a1b0e70c12efabe6a2cab3c9bc66db340">UCP_EP_PARAM_FIELD_ERR_HANDLING_MODE</a> |</div><div class="line">                                <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60adc6619f5e4bf3f68190f918ee064036d">UCP_EP_PARAM_FIELD_ERR_HANDLER</a> |</div><div class="line">                                <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60afc6cbbfabd368438e5d6afd36f389d1b">UCP_EP_PARAM_FIELD_USER_DATA</a>;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#a8cf5c1599022ccdea5a6d1c97ced3627">address</a>         = peer_addr;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#a50ce29893509695caa5b70ab4525a4d6">err_mode</a>        = err_handling_opt.ucp_err_mode;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aaf329de9e2b45311099cee8c9df43a20">err_handler</a>.<a class="code" href="group___u_c_p___c_o_m_m.html#a0bf3f446a1821a62dd3a300584792e33">cb</a>  = failure_handler;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aaf329de9e2b45311099cee8c9df43a20">err_handler</a>.<a class="code" href="group___u_c_p___c_o_m_m.html#a7e49e1843e1adab5561e5fc2b2e1afb1">arg</a> = NULL;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#adaf49e16ee05400f715f432e442336cb">user_data</a>       = &amp;ep_status;</div><div class="line"></div><div class="line">    status = <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga6cc5ffb2ba1b0ccd510848de0a779f7b">ucp_ep_create</a>(ucp_worker, &amp;ep_params, &amp;client_ep);</div><div class="line">    <span class="comment">/* If peer failure testing was requested, it could be possible that UCP EP</span></div><div class="line"><span class="comment">     * couldn&#39;t be created; in this case set `ret = 0` to report success */</span></div><div class="line">    ret = (err_handling_opt.failure_mode != FAILURE_MODE_NONE) ? 0 : -1;</div><div class="line">    CHKERR_ACTION(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;ucp_ep_create\n&quot;</span>, <span class="keywordflow">goto</span> err);</div><div class="line"></div><div class="line">    msg_len = <span class="keyword">sizeof</span>(*msg) + test_string_length;</div><div class="line">    msg = mem_type_malloc(msg_len);</div><div class="line">    CHKERR_ACTION(msg == NULL, <span class="stringliteral">&quot;allocate memory\n&quot;</span>, ret = -1; <span class="keywordflow">goto</span> err_ep);</div><div class="line">    mem_type_memset(msg, 0, msg_len);</div><div class="line"></div><div class="line">    set_msg_data_len(msg, msg_len - <span class="keyword">sizeof</span>(*msg));</div><div class="line">    ret = generate_test_string((<span class="keywordtype">char</span> *)(msg + 1), test_string_length);</div><div class="line">    CHKERR_JUMP(ret &lt; 0, <span class="stringliteral">&quot;generate test string&quot;</span>, err_free_mem_type_msg);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (err_handling_opt.failure_mode == FAILURE_MODE_RECV) {</div><div class="line">        <span class="comment">/* Sleep for small amount of time to ensure that client was killed</span></div><div class="line"><span class="comment">         * and peer failure handling is covered */</span></div><div class="line">        sleep(5);</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line"></div><div class="line">    send_param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a> = <a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a73e3a6e8b96b37ec1b0764e67dd13602">UCP_OP_ATTR_FIELD_CALLBACK</a>  |</div><div class="line">                              <a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610af6f932f15331fe7c9efacbfe2578e5ec">UCP_OP_ATTR_FIELD_USER_DATA</a> |</div><div class="line">                              <a name="a37"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a768b4c6759502c34b0051ba33c0d05b3">UCP_OP_ATTR_FIELD_MEMORY_TYPE</a>;</div><div class="line">    send_param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.send      = send_handler;</div><div class="line">    send_param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#aa9092d65a2e4e55368ca4f88775c190b">user_data</a>    = (<span class="keywordtype">void</span>*)data_msg_str;</div><div class="line">    send_param.<a name="a38"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a52b53447384778b16b3b91d6abeb0f86">memory_type</a>  = test_mem_type;</div><div class="line">    request                 = <a class="code" href="group___u_c_p___c_o_m_m.html#ga8323878b60f426c630d4ff8996ede3cc">ucp_tag_send_nbx</a>(client_ep, msg, msg_len, tag,</div><div class="line">                                               &amp;send_param);</div><div class="line">    status                  = ucx_wait(ucp_worker, request, <span class="stringliteral">&quot;send&quot;</span>,</div><div class="line">                                       data_msg_str);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        <span class="keywordflow">if</span> (err_handling_opt.failure_mode != FAILURE_MODE_NONE) {</div><div class="line">            ret = -1;</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            <span class="comment">/* If peer failure testing was requested, set `ret = 0` to report</span></div><div class="line"><span class="comment">             * success from the application */</span></div><div class="line">            ret = 0;</div><div class="line"></div><div class="line">            <span class="comment">/* Make sure that failure_handler was called */</span></div><div class="line">            <span class="keywordflow">while</span> (ep_status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">                <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">goto</span> err_free_mem_type_msg;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (err_handling_opt.failure_mode == FAILURE_MODE_KEEPALIVE) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Waiting for client is terminated\n&quot;</span>);</div><div class="line">        <span class="keywordflow">while</span> (ep_status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">            <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    status = flush_ep(ucp_worker, client_ep);</div><div class="line">    printf(<span class="stringliteral">&quot;flush_ep completed with status %d (%s)\n&quot;</span>,</div><div class="line">           status, ucs_status_string(status));</div><div class="line"></div><div class="line">    ret = 0;</div><div class="line"></div><div class="line">err_free_mem_type_msg:</div><div class="line">    mem_type_free(msg);</div><div class="line">err_ep:</div><div class="line">    <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#gac63b3fe87c001dd965ca42943ea04bb1">ucp_ep_destroy</a>(client_ep);</div><div class="line">err:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> run_test(<span class="keyword">const</span> <span class="keywordtype">char</span> *client_target_name, <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (client_target_name != NULL) {</div><div class="line">        <span class="keywordflow">return</span> run_ucx_client(ucp_worker);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <span class="keywordflow">return</span> run_ucx_server(ucp_worker);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">    <span class="comment">/* UCP temporary vars */</span></div><div class="line">    <a name="_a39"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params_t</a> <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>;</div><div class="line">    <a name="_a40"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#structucp__worker__params">ucp_worker_params_t</a> worker_params;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#gab4fd46edba365347ef3a5b966c324388">ucp_config_t</a> *config;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line"></div><div class="line">    <span class="comment">/* UCP handler objects */</span></div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ga0e40ddc46f0bbe868a13f6ab1b674f76">ucp_context_h</a> ucp_context;</div><div class="line">    <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker;</div><div class="line"></div><div class="line">    <span class="comment">/* OOB connection vars */</span></div><div class="line">    uint64_t addr_len = 0;</div><div class="line">    <span class="keywordtype">char</span> *client_target_name = NULL;</div><div class="line">    <span class="keywordtype">int</span> oob_sock = -1;</div><div class="line">    <span class="keywordtype">int</span> ret = -1;</div><div class="line"></div><div class="line">    memset(&amp;<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>));</div><div class="line">    memset(&amp;worker_params, 0, <span class="keyword">sizeof</span>(worker_params));</div><div class="line"></div><div class="line">    <span class="comment">/* Parse the command line */</span></div><div class="line">    status = parse_cmd(argc, argv, &amp;client_target_name);</div><div class="line">    CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;parse_cmd\n&quot;</span>, err);</div><div class="line"></div><div class="line">    <span class="comment">/* UCP initialization */</span></div><div class="line">    status = <a name="a41"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#gab2a5bd39a60f5326771c7a46f5f93319">ucp_config_read</a>(NULL, NULL, &amp;config);</div><div class="line">    CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;ucp_config_read\n&quot;</span>, err);</div><div class="line"></div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a name="a42"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#a62d432cd22de13ccc9bb12edeb9c566b">field_mask</a>   = <a name="a43"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggab43f613a2365147415abf66f571cfa71a454f1e90a324095192d87d97b8a4321f">UCP_PARAM_FIELD_FEATURES</a> |</div><div class="line">                              <a name="a44"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggab43f613a2365147415abf66f571cfa71a8385ca52048353e69b90fb7c6b0799ee">UCP_PARAM_FIELD_REQUEST_SIZE</a> |</div><div class="line">                              <a name="a45"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggab43f613a2365147415abf66f571cfa71ac95d94f94370df6cd79db8e830505738">UCP_PARAM_FIELD_REQUEST_INIT</a>;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a name="a46"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#afe7ed2a6c6ceb48e18a04f524d844e67">features</a>     = <a name="a47"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggaca5990bc015e7e9ac3e3be4e3611c5bea244187ad85296b3784d302db00f66b9e">UCP_FEATURE_TAG</a>;</div><div class="line">    <span class="keywordflow">if</span> (ucp_test_mode == TEST_MODE_WAIT || ucp_test_mode == TEST_MODE_EVENTFD) {</div><div class="line">        <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#afe7ed2a6c6ceb48e18a04f524d844e67">features</a> |= <a name="a48"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggaca5990bc015e7e9ac3e3be4e3611c5beabc3fea5aff6b7453e24235bceb102b5a">UCP_FEATURE_WAKEUP</a>;</div><div class="line">    }</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a name="a49"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#a3125e61440123f639c024d75b5edc0d6">request_size</a>    = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ucx_context);</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a name="a50"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#ac1f0a25d794111217af5e0e6b9865458">request_init</a>    = request_init;</div><div class="line"></div><div class="line">    status = <a name="a51"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ga3ad3662ebafac88ec666be4caeb76cb2">ucp_init</a>(&amp;<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>, config, &amp;ucp_context);</div><div class="line"></div><div class="line">    <a name="a52"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#ga52f4d762c9f3a61c98fb7ba95a00809e">ucp_config_print</a>(config, stdout, NULL, UCS_CONFIG_PRINT_CONFIG);</div><div class="line"></div><div class="line">    <a name="a53"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#ga12d1b29c55e927a22de92431efa0d82a">ucp_config_release</a>(config);</div><div class="line">    CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;ucp_init\n&quot;</span>, err);</div><div class="line"></div><div class="line">    worker_params.<a name="a54"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#a33863ec848e47f79d2e14181fe2aa921">field_mask</a>  = <a name="a55"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ggadbfc8fd5eaa65351d1617f2f158b80f6a651598f7340d42cafb0876d918c83ec8">UCP_WORKER_PARAM_FIELD_THREAD_MODE</a>;</div><div class="line">    worker_params.<a name="a56"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#a790642ea681ddd2b0935ad62f70e4ef1">thread_mode</a> = <a name="a57"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga40e9f363c389e702ad9920f5d52525ceabc2f71e39a3527f7abe6a1c47f0a5a25">UCS_THREAD_MODE_SINGLE</a>;</div><div class="line"></div><div class="line">    status = <a name="a58"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga0aec01ed3dad646ca6cd3814b13054b1">ucp_worker_create</a>(ucp_context, &amp;worker_params, &amp;ucp_worker);</div><div class="line">    CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;ucp_worker_create\n&quot;</span>, err_cleanup);</div><div class="line"></div><div class="line">    status = <a name="a59"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga41aaa5fb8fbd3de50a39b1fda12977cc">ucp_worker_get_address</a>(ucp_worker, &amp;local_addr, &amp;local_addr_len);</div><div class="line">    CHKERR_JUMP(status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>, <span class="stringliteral">&quot;ucp_worker_get_address\n&quot;</span>, err_worker);</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;[0x%x] local address length: %lu\n&quot;</span>,</div><div class="line">           (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)pthread_self(), local_addr_len);</div><div class="line"></div><div class="line">    <span class="comment">/* OOB connection establishment */</span></div><div class="line">    <span class="keywordflow">if</span> (client_target_name) {</div><div class="line">        peer_addr_len = local_addr_len;</div><div class="line"></div><div class="line">        oob_sock = client_connect(client_target_name, server_port);</div><div class="line">        CHKERR_JUMP(oob_sock &lt; 0, <span class="stringliteral">&quot;client_connect\n&quot;</span>, err_addr);</div><div class="line"></div><div class="line">        ret = recv(oob_sock, &amp;addr_len, <span class="keyword">sizeof</span>(addr_len), MSG_WAITALL);</div><div class="line">        CHKERR_JUMP_RETVAL(ret != (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(addr_len),</div><div class="line">                           <span class="stringliteral">&quot;receive address length\n&quot;</span>, err_addr, ret);</div><div class="line"></div><div class="line">        peer_addr_len = addr_len;</div><div class="line">        peer_addr = malloc(peer_addr_len);</div><div class="line">        CHKERR_JUMP(!peer_addr, <span class="stringliteral">&quot;allocate memory\n&quot;</span>, err_addr);</div><div class="line"></div><div class="line">        ret = recv(oob_sock, peer_addr, peer_addr_len, MSG_WAITALL);</div><div class="line">        CHKERR_JUMP_RETVAL(ret != (<span class="keywordtype">int</span>)peer_addr_len,</div><div class="line">                           <span class="stringliteral">&quot;receive address\n&quot;</span>, err_peer_addr, ret);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        oob_sock = server_connect(server_port);</div><div class="line">        CHKERR_JUMP(oob_sock &lt; 0, <span class="stringliteral">&quot;server_connect\n&quot;</span>, err_peer_addr);</div><div class="line"></div><div class="line">        addr_len = local_addr_len;</div><div class="line">        ret = send(oob_sock, &amp;addr_len, <span class="keyword">sizeof</span>(addr_len), 0);</div><div class="line">        CHKERR_JUMP_RETVAL(ret != (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(addr_len),</div><div class="line">                           <span class="stringliteral">&quot;send address length\n&quot;</span>, err_peer_addr, ret);</div><div class="line"></div><div class="line">        ret = send(oob_sock, local_addr, local_addr_len, 0);</div><div class="line">        CHKERR_JUMP_RETVAL(ret != (<span class="keywordtype">int</span>)local_addr_len, <span class="stringliteral">&quot;send address\n&quot;</span>,</div><div class="line">                           err_peer_addr, ret);</div><div class="line">    }</div><div class="line"></div><div class="line">    ret = run_test(client_target_name, ucp_worker);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!ret &amp;&amp; (err_handling_opt.failure_mode != FAILURE_MODE_NONE)) {</div><div class="line">        <span class="comment">/* Make sure remote is disconnected before destroying local worker */</span></div><div class="line">        ret = barrier(oob_sock);</div><div class="line">    }</div><div class="line">    close(oob_sock);</div><div class="line"></div><div class="line">err_peer_addr:</div><div class="line">    free(peer_addr);</div><div class="line"></div><div class="line">err_addr:</div><div class="line">    <a name="a60"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga94260829739496267d2c8d86414b863d">ucp_worker_release_address</a>(ucp_worker, local_addr);</div><div class="line"></div><div class="line">err_worker:</div><div class="line">    <a name="a61"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga6b6c5bf97d16e7fc4b7c815875e92676">ucp_worker_destroy</a>(ucp_worker);</div><div class="line"></div><div class="line">err_cleanup:</div><div class="line">    <a name="a62"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#gaaa7a90069ad6e0f3e227402db265299e">ucp_cleanup</a>(ucp_context);</div><div class="line"></div><div class="line">err:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_usage()</div><div class="line">{</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Usage: ucp_hello_world [parameters]\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;UCP hello world client/server example utility\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\nParameters are:\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  -w      Select test mode \&quot;wait\&quot; to test &quot;</span></div><div class="line">            <span class="stringliteral">&quot;ucp_worker_wait function\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  -f      Select test mode \&quot;event fd\&quot; to test &quot;</span></div><div class="line">            <span class="stringliteral">&quot;ucp_worker_get_efd function with later poll\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  -b      Select test mode \&quot;busy polling\&quot; to test &quot;</span></div><div class="line">            <span class="stringliteral">&quot;ucp_tag_probe_nb and ucp_worker_progress (default)\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  -n &lt;name&gt; Set node name or IP address &quot;</span></div><div class="line">            <span class="stringliteral">&quot;of the server (required for client and should be ignored &quot;</span></div><div class="line">            <span class="stringliteral">&quot;for server)\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  -e &lt;type&gt; Emulate unexpected failure and handle an &quot;</span></div><div class="line">                                <span class="stringliteral">&quot;error with enabled UCP_ERR_HANDLING_MODE_PEER\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;            send      - send failure on server side &quot;</span></div><div class="line">                                <span class="stringliteral">&quot;before send initiated\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;            recv      - receive failure on client side &quot;</span></div><div class="line">                                <span class="stringliteral">&quot;before receive completed\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;            keepalive - keepalive failure on client side &quot;</span></div><div class="line">                                <span class="stringliteral">&quot;after communication completed\n&quot;</span>);</div><div class="line">    print_common_help();</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> parse_cmd(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * <span class="keyword">const</span> argv[], <span class="keywordtype">char</span> **server_name)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> c = 0, idx = 0;</div><div class="line"></div><div class="line">    err_handling_opt.ucp_err_mode = <a name="a63"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#gga7c69a28724d5ae3e49490e23e64df167a18c7855c2e1dea33e0be32d9ef841ffe">UCP_ERR_HANDLING_MODE_NONE</a>;</div><div class="line">    err_handling_opt.failure_mode = FAILURE_MODE_NONE;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">&quot;wfbe:n:p:s:m:h&quot;</span>)) != -1) {</div><div class="line">        <span class="keywordflow">switch</span> (c) {</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;w&#39;</span>:</div><div class="line">            ucp_test_mode = TEST_MODE_WAIT;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:</div><div class="line">            ucp_test_mode = TEST_MODE_EVENTFD;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:</div><div class="line">            ucp_test_mode = TEST_MODE_PROBE;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:</div><div class="line">            err_handling_opt.ucp_err_mode = <a name="a64"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#gga7c69a28724d5ae3e49490e23e64df167aa31630259732e700b6ce0fe612cf0a6f">UCP_ERR_HANDLING_MODE_PEER</a>;</div><div class="line">            <span class="keywordflow">if</span> (!strcmp(optarg, <span class="stringliteral">&quot;recv&quot;</span>)) {</div><div class="line">                err_handling_opt.failure_mode = FAILURE_MODE_RECV;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(optarg, <span class="stringliteral">&quot;send&quot;</span>)) {</div><div class="line">                err_handling_opt.failure_mode = FAILURE_MODE_SEND;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(optarg, <span class="stringliteral">&quot;keepalive&quot;</span>)) {</div><div class="line">                err_handling_opt.failure_mode = FAILURE_MODE_KEEPALIVE;</div><div class="line">            } <span class="keywordflow">else</span> {</div><div class="line">                print_usage();</div><div class="line">                <span class="keywordflow">return</span> <a name="a65"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:</div><div class="line">            *server_name = optarg;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div><div class="line">            server_port = atoi(optarg);</div><div class="line">            <span class="keywordflow">if</span> (server_port &lt;= 0) {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Wrong server port number %d\n&quot;</span>, server_port);</div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:</div><div class="line">            test_string_length = atol(optarg);</div><div class="line">            <span class="keywordflow">if</span> (test_string_length &lt; 0) {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Wrong string size %ld\n&quot;</span>, test_string_length);</div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">            }   </div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:</div><div class="line">            test_mem_type = parse_mem_type(optarg);</div><div class="line">            <span class="keywordflow">if</span> (test_mem_type == <a name="a66"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga5cfcc524f5dc586101a3e7caff8d982da6105aba9983dc25cbf7cbf4d03f655d7">UCS_MEMORY_TYPE_LAST</a>) {</div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            print_usage();</div><div class="line">            <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;INFO: UCP_HELLO_WORLD mode = %d server = %s port = %d, pid = %d\n&quot;</span>,</div><div class="line">            ucp_test_mode, *server_name, server_port, getpid());</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (idx = optind; idx &lt; argc; idx++) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;WARNING: Non-option argument %s\n&quot;</span>, argv[idx]);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Aug 1 2021 15:26:04 for UCX by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
