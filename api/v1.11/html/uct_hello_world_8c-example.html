<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UCX: uct_hello_world.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="UCX_Logo_80x80.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UCX
   &#160;<span id="projectnumber">1.11</span>
   </div>
   <div id="projectbrief">Unified Communication X</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('uct_hello_world_8c-example.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">uct_hello_world.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>UCT hello world client / server example utility.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;hello_world_util.h&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;limits.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;uct/api/uct.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div><div class="line">    FUNC_AM_SHORT,</div><div class="line">    FUNC_AM_BCOPY,</div><div class="line">    FUNC_AM_ZCOPY</div><div class="line">} func_am_t;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <span class="keywordtype">int</span>  is_uct_desc;</div><div class="line">} recv_desc_t;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <span class="keywordtype">char</span>               *server_name;</div><div class="line">    uint16_t            server_port;</div><div class="line">    func_am_t           func_am_type;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>         *dev_name;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>         *tl_name;</div><div class="line">    <span class="keywordtype">long</span>                test_strlen;</div><div class="line">} cmd_args_t;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <a name="_a0"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__iface__attr">uct_iface_attr_t</a>    iface_attr; <span class="comment">/* Interface attributes: capabilities and limitations */</span></div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gab6decd0363732ac4187bf7aa37883c35">uct_iface_h</a>         iface;      <span class="comment">/* Communication interface context */</span></div><div class="line">    <a name="_a1"></a><a class="code" href="group___u_c_t___m_d.html#structuct__md__attr">uct_md_attr_t</a>       md_attr;    <span class="comment">/* Memory domain attributes: capabilities and limitations */</span></div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga80ea2d5570f0cef850d315ce72ea8307">uct_md_h</a>            md;         <span class="comment">/* Memory domain */</span></div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga2c776904a7202aa95ec1ceecfe74f2f9">uct_worker_h</a>        worker;     <span class="comment">/* Workers represent allocated resources in a communication thread */</span></div><div class="line">} iface_info_t;</div><div class="line"></div><div class="line"><span class="comment">/* Helper data type for am_short */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    uint64_t            header;</div><div class="line">    <span class="keywordtype">char</span>               *payload;</div><div class="line">    <span class="keywordtype">size_t</span>              len;</div><div class="line">} am_short_args_t;</div><div class="line"></div><div class="line"><span class="comment">/* Helper data type for am_bcopy */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <span class="keywordtype">char</span>               *data;</div><div class="line">    <span class="keywordtype">size_t</span>              len;</div><div class="line">} am_bcopy_args_t;</div><div class="line"></div><div class="line"><span class="comment">/* Helper data type for am_zcopy */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <a name="_a2"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__completion">uct_completion_t</a>    uct_comp;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga80ea2d5570f0cef850d315ce72ea8307">uct_md_h</a>            md;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga2af4d7f2a70d4ac5eaef079dc68506b8">uct_mem_h</a>           memh;</div><div class="line">} zcopy_comp_t;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>* desc_holder = NULL;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> print_err_usage(<span class="keywordtype">void</span>);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *func_am_t_str(func_am_t func_am_type)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (func_am_type) {</div><div class="line">    <span class="keywordflow">case</span> FUNC_AM_SHORT:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;uct_ep_am_short&quot;</span>;</div><div class="line">    <span class="keywordflow">case</span> FUNC_AM_BCOPY:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;uct_ep_am_bcopy&quot;</span>;</div><div class="line">    <span class="keywordflow">case</span> FUNC_AM_ZCOPY:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;uct_ep_am_zcopy&quot;</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">size_t</span> func_am_max_size(func_am_t func_am_type,</div><div class="line">                               <span class="keyword">const</span> <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__iface__attr">uct_iface_attr_t</a> *attr)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (func_am_type) {</div><div class="line">    <span class="keywordflow">case</span> FUNC_AM_SHORT:</div><div class="line">        <span class="keywordflow">return</span> attr-&gt;<a name="a3"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#aff010f596f41cdceae41e6c46652e1ca">cap</a>.am.max_short;</div><div class="line">    <span class="keywordflow">case</span> FUNC_AM_BCOPY:</div><div class="line">        <span class="keywordflow">return</span> attr-&gt;<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#aff010f596f41cdceae41e6c46652e1ca">cap</a>.am.max_bcopy;</div><div class="line">    <span class="keywordflow">case</span> FUNC_AM_ZCOPY:</div><div class="line">        <span class="keywordflow">return</span> attr-&gt;<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#aff010f596f41cdceae41e6c46652e1ca">cap</a>.am.max_zcopy;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Helper function for am_short */</span></div><div class="line"><span class="keywordtype">void</span> am_short_params_pack(<span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len, am_short_args_t *args)</div><div class="line">{</div><div class="line">    args-&gt;header      = *(uint64_t *)buf;</div><div class="line">    <span class="keywordflow">if</span> (len &gt; <span class="keyword">sizeof</span>(args-&gt;header)) {</div><div class="line">        args-&gt;payload = (buf + <span class="keyword">sizeof</span>(args-&gt;header));</div><div class="line">        args-&gt;len     = len - <span class="keyword">sizeof</span>(args-&gt;header);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        args-&gt;payload = NULL;</div><div class="line">        args-&gt;len     = 0;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> do_am_short(iface_info_t *if_info, <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gae7298a2b6fdb0e7771868459b10d6b20">uct_ep_h</a> ep, uint8_t <span class="keywordtype">id</span>,</div><div class="line">                         <span class="keyword">const</span> cmd_args_t *cmd_args, <span class="keywordtype">char</span> *buf)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>    status;</div><div class="line">    am_short_args_t send_args;</div><div class="line"></div><div class="line">    am_short_params_pack(buf, cmd_args-&gt;test_strlen, &amp;send_args);</div><div class="line"></div><div class="line">    <span class="keywordflow">do</span> {</div><div class="line">        <span class="comment">/* Send active message to remote endpoint */</span></div><div class="line">        status = <a name="a4"></a><a class="code" href="group___u_c_t___a_m.html#ga0d170165e2d16dccbe45588ebad181f3">uct_ep_am_short</a>(ep, <span class="keywordtype">id</span>, send_args.header, send_args.payload,</div><div class="line">                                 send_args.len);</div><div class="line">        <a name="a5"></a><a class="code" href="group___u_c_t___c_o_n_t_e_x_t.html#ga4ec9fae48afd24d7fa7c5537e76b54e5">uct_worker_progress</a>(if_info-&gt;worker);</div><div class="line">    } <span class="keywordflow">while</span> (status == <a name="a6"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a83fc93632e7b3e3251410985aab27edc">UCS_ERR_NO_RESOURCE</a>);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Pack callback for am_bcopy */</span></div><div class="line"><span class="keywordtype">size_t</span> am_bcopy_data_pack_cb(<span class="keywordtype">void</span> *dest, <span class="keywordtype">void</span> *arg)</div><div class="line">{</div><div class="line">    am_bcopy_args_t *bc_args = arg;</div><div class="line">    mem_type_memcpy(dest, bc_args-&gt;data, bc_args-&gt;len);</div><div class="line">    <span class="keywordflow">return</span> bc_args-&gt;len;</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> do_am_bcopy(iface_info_t *if_info, <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gae7298a2b6fdb0e7771868459b10d6b20">uct_ep_h</a> ep, uint8_t <span class="keywordtype">id</span>,</div><div class="line">                         <span class="keyword">const</span> cmd_args_t *cmd_args, <span class="keywordtype">char</span> *buf)</div><div class="line">{</div><div class="line">    am_bcopy_args_t args;</div><div class="line">    ssize_t len;</div><div class="line"></div><div class="line">    args.data = buf;</div><div class="line">    args.len  = cmd_args-&gt;test_strlen;</div><div class="line"></div><div class="line">    <span class="comment">/* Send active message to remote endpoint */</span></div><div class="line">    <span class="keywordflow">do</span> {</div><div class="line">        len = <a name="a7"></a><a class="code" href="group___u_c_t___a_m.html#gae29dad6b69beaf21c19255906742e14d">uct_ep_am_bcopy</a>(ep, <span class="keywordtype">id</span>, am_bcopy_data_pack_cb, &amp;args, 0);</div><div class="line">        <a class="code" href="group___u_c_t___c_o_n_t_e_x_t.html#ga4ec9fae48afd24d7fa7c5537e76b54e5">uct_worker_progress</a>(if_info-&gt;worker);</div><div class="line">    } <span class="keywordflow">while</span> (len == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a83fc93632e7b3e3251410985aab27edc">UCS_ERR_NO_RESOURCE</a>);</div><div class="line">    <span class="comment">/* Negative len is an error code */</span></div><div class="line">    <span class="keywordflow">return</span> (len &gt;= 0) ? <a name="a8"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> : (<a name="a9"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>)len;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Completion callback for am_zcopy */</span></div><div class="line"><span class="keywordtype">void</span> zcopy_completion_cb(<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__completion">uct_completion_t</a> *<span class="keyword">self</span>)</div><div class="line">{</div><div class="line">    zcopy_comp_t *comp = (zcopy_comp_t *)<span class="keyword">self</span>;</div><div class="line">    assert((comp-&gt;uct_comp.count == 0) &amp;&amp; (self-&gt;status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>));</div><div class="line">    <span class="keywordflow">if</span> (comp-&gt;memh != UCT_MEM_HANDLE_NULL) {</div><div class="line">        <a name="a10"></a><a class="code" href="group___u_c_t___m_d.html#gaf1e9ff0364ec4d2bb05c06a2fab67dd5">uct_md_mem_dereg</a>(comp-&gt;md, comp-&gt;memh);</div><div class="line">    }</div><div class="line">    desc_holder = (<span class="keywordtype">void</span> *)0xDEADBEEF;</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> do_am_zcopy(iface_info_t *if_info, <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gae7298a2b6fdb0e7771868459b10d6b20">uct_ep_h</a> ep, uint8_t <span class="keywordtype">id</span>,</div><div class="line">                         <span class="keyword">const</span> cmd_args_t *cmd_args, <span class="keywordtype">char</span> *buf)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga2af4d7f2a70d4ac5eaef079dc68506b8">uct_mem_h</a> memh;</div><div class="line">    <a name="_a11"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__iov">uct_iov_t</a> iov;</div><div class="line">    zcopy_comp_t comp;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (if_info-&gt;md_attr.cap.flags &amp; <a name="a12"></a><a class="code" href="group___u_c_t___m_d.html#gga61dadd085c1777f559549e05962b2c9ea8badc53da14cdd45fa70178483091e55">UCT_MD_FLAG_NEED_MEMH</a>) {</div><div class="line">        status = <a name="a13"></a><a class="code" href="group___u_c_t___m_d.html#gadafbaee4d8462954361fd2a41c8069e0">uct_md_mem_reg</a>(if_info-&gt;md, buf, cmd_args-&gt;test_strlen,</div><div class="line">                                <a name="a14"></a><a class="code" href="group___u_c_t___m_d.html#gga3b0345adc84e4b3224366502aca5e11aa53c0d5770a5c69086d0aaa58e7398fa8">UCT_MD_MEM_ACCESS_RMA</a>, &amp;memh);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        memh = UCT_MEM_HANDLE_NULL;</div><div class="line">    }</div><div class="line"></div><div class="line">    iov.<a name="a15"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a315a759f0ec81b26fcba7530e43d9149">buffer</a> = buf;</div><div class="line">    iov.<a name="a16"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ad00b6e55c209c6abc87b091f4c776cd5">length</a> = cmd_args-&gt;test_strlen;</div><div class="line">    iov.<a name="a17"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a9a24e4be8303ebd6906bcaff37ab31f7">memh</a>   = memh;</div><div class="line">    iov.<a name="a18"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a21ea5b278cab407db05eaa3dce3b2824">stride</a> = 0;</div><div class="line">    iov.<a name="a19"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#addb247a8d80907156df00159bbafcda5">count</a>  = 1;</div><div class="line"></div><div class="line">    comp.uct_comp.func   = zcopy_completion_cb;</div><div class="line">    comp.uct_comp.count  = 1;</div><div class="line">    comp.uct_comp.status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">    comp.md              = if_info-&gt;md;</div><div class="line">    comp.memh            = memh;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        <span class="keywordflow">do</span> {</div><div class="line">            status = <a name="a20"></a><a class="code" href="group___u_c_t___a_m.html#gae79d303f72e688df6d49bc44823c2210">uct_ep_am_zcopy</a>(ep, <span class="keywordtype">id</span>, NULL, 0, &amp;iov, 1, 0,</div><div class="line">                                     (<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__completion">uct_completion_t</a> *)&amp;comp);</div><div class="line">            <a class="code" href="group___u_c_t___c_o_n_t_e_x_t.html#ga4ec9fae48afd24d7fa7c5537e76b54e5">uct_worker_progress</a>(if_info-&gt;worker);</div><div class="line">        } <span class="keywordflow">while</span> (status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a83fc93632e7b3e3251410985aab27edc">UCS_ERR_NO_RESOURCE</a>);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (status == <a name="a21"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a77aa02620851779729e4ad6ceb41f84a">UCS_INPROGRESS</a>) {</div><div class="line">            <span class="keywordflow">while</span> (!desc_holder) {</div><div class="line">                <span class="comment">/* Explicitly progress outstanding active message request */</span></div><div class="line">                <a class="code" href="group___u_c_t___c_o_n_t_e_x_t.html#ga4ec9fae48afd24d7fa7c5537e76b54e5">uct_worker_progress</a>(if_info-&gt;worker);</div><div class="line">            }</div><div class="line">            status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_strings(<span class="keyword">const</span> <span class="keywordtype">char</span> *label, <span class="keyword">const</span> <span class="keywordtype">char</span> *local_str,</div><div class="line">                          <span class="keyword">const</span> <span class="keywordtype">char</span> *remote_str, <span class="keywordtype">size_t</span> length)</div><div class="line">{</div><div class="line">    fprintf(stdout, <span class="stringliteral">&quot;\n\n----- UCT TEST SUCCESS ----\n\n&quot;</span>);</div><div class="line">    fprintf(stdout, <span class="stringliteral">&quot;[%s] %s sent %s (%&quot;</span> PRIu64 <span class="stringliteral">&quot; bytes)&quot;</span>, label, local_str,</div><div class="line">            (length != 0) ? remote_str : <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>, length);</div><div class="line">    fprintf(stdout, <span class="stringliteral">&quot;\n\n---------------------------\n&quot;</span>);</div><div class="line">    fflush(stdout);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Callback to handle receive active message */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> hello_world(<span class="keywordtype">void</span> *arg, <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> length,</div><div class="line">                                <span class="keywordtype">unsigned</span> flags)</div><div class="line">{</div><div class="line">    func_am_t func_am_type = *(func_am_t *)arg;</div><div class="line">    recv_desc_t *rdesc;</div><div class="line"></div><div class="line">    print_strings(<span class="stringliteral">&quot;callback&quot;</span>, func_am_t_str(func_am_type), data, length);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (flags &amp; <a name="a22"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga36bfc11c722b01a11e1949e8329262c9a741f6a62c34d5484fa6999b1e097e42a">UCT_CB_PARAM_FLAG_DESC</a>) {</div><div class="line">        rdesc = (recv_desc_t *)data - 1;</div><div class="line">        <span class="comment">/* Hold descriptor to release later and return UCS_INPROGRESS */</span></div><div class="line">        rdesc-&gt;is_uct_desc = 1;</div><div class="line">        desc_holder = rdesc;</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a77aa02620851779729e4ad6ceb41f84a">UCS_INPROGRESS</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* We need to copy-out data and return UCS_OK if want to use the data</span></div><div class="line"><span class="comment">     * outside the callback */</span></div><div class="line">    rdesc = malloc(<span class="keyword">sizeof</span>(*rdesc) + length);</div><div class="line">    CHKERR_ACTION(rdesc == NULL, <span class="stringliteral">&quot;allocate memory\n&quot;</span>, <span class="keywordflow">return</span> <a name="a23"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a9919ffd4eaf870612c4aa63df65ae0a6">UCS_ERR_NO_MEMORY</a>);</div><div class="line">    rdesc-&gt;is_uct_desc = 0;</div><div class="line">    memcpy(rdesc + 1, data, length);</div><div class="line">    desc_holder = rdesc;</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Init the transport by its name */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> init_iface(<span class="keywordtype">char</span> *dev_name, <span class="keywordtype">char</span> *tl_name,</div><div class="line">                               func_am_t func_am_type,</div><div class="line">                               iface_info_t *iface_p)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>        status;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga9769f5a67e7c711eb95abe993f794207">uct_iface_config_t</a>  *config; <span class="comment">/* Defines interface configuration options */</span></div><div class="line">    <a name="_a24"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__iface__params">uct_iface_params_t</a>  params;</div><div class="line"></div><div class="line">    params.<a name="a25"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a9e1d45a55b7e9629eb548f27bea940a0">field_mask</a>           = <a name="a26"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga896baeefc7933d925202c32b0d09f596a436751cf65204ec8d37e649b0913eff7">UCT_IFACE_PARAM_FIELD_OPEN_MODE</a>   |</div><div class="line">                                  <a name="a27"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga896baeefc7933d925202c32b0d09f596a0f56ae54f7fcd7a002588a75e207f8a2">UCT_IFACE_PARAM_FIELD_DEVICE</a>      |</div><div class="line">                                  <a name="a28"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga896baeefc7933d925202c32b0d09f596a7af1c01a0aa6c8d7ddc167cd516f3272">UCT_IFACE_PARAM_FIELD_STATS_ROOT</a>  |</div><div class="line">                                  <a name="a29"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga896baeefc7933d925202c32b0d09f596aabb0425ec3c58345ba973683b72dc255">UCT_IFACE_PARAM_FIELD_RX_HEADROOM</a> |</div><div class="line">                                  <a name="a30"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga896baeefc7933d925202c32b0d09f596a80cd3b1a8f9de031df8aa12e7a0eb08b">UCT_IFACE_PARAM_FIELD_CPU_MASK</a>;</div><div class="line">    params.<a name="a31"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a7db3b0fb2bbde6b4625ad5a6c5e1a043">open_mode</a>            = <a name="a32"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga8bc9c95ee7fbd76321940e2853d08bb5a504bef9a8574445a0dfdcf517160fef0">UCT_IFACE_OPEN_MODE_DEVICE</a>;</div><div class="line">    params.<a name="a33"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a7fa862d179a7605eef34de73e11869fe">mode</a>.device.tl_name  = tl_name;</div><div class="line">    params.<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a7fa862d179a7605eef34de73e11869fe">mode</a>.device.dev_name = dev_name;</div><div class="line">    params.<a name="a34"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a6d87dd22dc349557a706bb25d49975f0">stats_root</a>           = NULL;</div><div class="line">    params.<a name="a35"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#aea4ca94171e8dfe3e80abb74a06fe333">rx_headroom</a>          = <span class="keyword">sizeof</span>(recv_desc_t);</div><div class="line"></div><div class="line">    UCS_CPU_ZERO(&amp;params.<a name="a36"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a7093f64ec5efe2f1c3833dbe90b9099a">cpu_mask</a>);</div><div class="line">    <span class="comment">/* Read transport-specific interface configuration */</span></div><div class="line">    status = <a name="a37"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gace64468ec8d46cbcbcfa6efd74e1148c">uct_md_iface_config_read</a>(iface_p-&gt;md, tl_name, NULL, NULL, &amp;config);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;setup iface_config&quot;</span>, error_ret);</div><div class="line"></div><div class="line">    <span class="comment">/* Open communication interface */</span></div><div class="line">    assert(iface_p-&gt;iface == NULL);</div><div class="line">    status = <a name="a38"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga031e2c99f03585c0f4c7356c71f0fbb1">uct_iface_open</a>(iface_p-&gt;md, iface_p-&gt;worker, &amp;params, config,</div><div class="line">                            &amp;iface_p-&gt;iface);</div><div class="line">    <a name="a39"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga951ea184730bc0b9cf659b1038e999a4">uct_config_release</a>(config);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;open temporary interface&quot;</span>, error_ret);</div><div class="line"></div><div class="line">    <span class="comment">/* Enable progress on the interface */</span></div><div class="line">    <a name="a40"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga9f14d2694a06d5ea9e6434a52f8d3ff0">uct_iface_progress_enable</a>(iface_p-&gt;iface,</div><div class="line">                              <a name="a41"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga71bfe6e07ebbcc036f883b31db1e9e51a5a00ade1aed7157a0662d8a4ae9cc2f5">UCT_PROGRESS_SEND</a> | <a name="a42"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga71bfe6e07ebbcc036f883b31db1e9e51a13a7d7c06d204f61b5de0cdf3ede1957">UCT_PROGRESS_RECV</a>);</div><div class="line"></div><div class="line">    <span class="comment">/* Get interface attributes */</span></div><div class="line">    status = <a name="a43"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac2ec7cdee76fa075cc65185d7c134bc2">uct_iface_query</a>(iface_p-&gt;iface, &amp;iface_p-&gt;iface_attr);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;query iface&quot;</span>, error_iface);</div><div class="line"></div><div class="line">    <span class="comment">/* Check if current device and transport support required active messages */</span></div><div class="line">    <span class="keywordflow">if</span> ((func_am_type == FUNC_AM_SHORT) &amp;&amp;</div><div class="line">        (iface_p-&gt;iface_attr.cap.flags &amp; <a name="a44"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e___i_f_a_c_e___c_a_p.html#gaa58cb476c781afcc74ce00849cc1884c">UCT_IFACE_FLAG_AM_SHORT</a>)) {</div><div class="line">        <span class="keywordflow">if</span> (test_mem_type != <a name="a45"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga5cfcc524f5dc586101a3e7caff8d982dafc4cb4732ebd0539e364bb6a4466c2fc">UCS_MEMORY_TYPE_CUDA</a>) {</div><div class="line">            <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;AM short protocol doesn&#39;t support CUDA memory&quot;</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((func_am_type == FUNC_AM_BCOPY) &amp;&amp;</div><div class="line">        (iface_p-&gt;iface_attr.cap.flags &amp; <a name="a46"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e___i_f_a_c_e___c_a_p.html#ga157f699933110d47857b84d06de36c21">UCT_IFACE_FLAG_AM_BCOPY</a>)) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((func_am_type == FUNC_AM_ZCOPY) &amp;&amp;</div><div class="line">        (iface_p-&gt;iface_attr.cap.flags &amp; <a name="a47"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e___i_f_a_c_e___c_a_p.html#ga480d42a7324a6944049f5f2ded5da783">UCT_IFACE_FLAG_AM_ZCOPY</a>)) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">error_iface:</div><div class="line">    <a name="a48"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga748bd92ba4e62fd86c6b002f9198e2aa">uct_iface_close</a>(iface_p-&gt;iface);</div><div class="line">    iface_p-&gt;iface = NULL;</div><div class="line">error_ret:</div><div class="line">    <span class="keywordflow">return</span> <a name="a49"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Device and transport to be used are determined by minimum latency */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> dev_tl_lookup(<span class="keyword">const</span> cmd_args_t *cmd_args,</div><div class="line">                                  iface_info_t *iface_p)</div><div class="line">{</div><div class="line">    <a name="_a50"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__tl__resource__desc">uct_tl_resource_desc_t</a> *tl_resources    = NULL; <span class="comment">/* Communication resource descriptor */</span></div><div class="line">    <span class="keywordtype">unsigned</span>               num_tl_resources = 0;    <span class="comment">/* Number of transport resources resource objects created */</span></div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga970f9dcfebb42f0209c2c7e23eca99f6">uct_component_h</a>        *components;</div><div class="line">    <span class="keywordtype">unsigned</span>               num_components;</div><div class="line">    <span class="keywordtype">unsigned</span>               cmpt_index;</div><div class="line">    <a name="_a51"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__component__attr">uct_component_attr_t</a>   component_attr;</div><div class="line">    <span class="keywordtype">unsigned</span>               md_index;</div><div class="line">    <span class="keywordtype">unsigned</span>               tl_index;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gabfb351862f43010ab8d5bbdb2495d0ee">uct_md_config_t</a>        *md_config;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>           status;</div><div class="line"></div><div class="line">    status = <a name="a52"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac11a18f80ae695355914c32095e5c75d">uct_query_components</a>(&amp;components, &amp;num_components);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;query for components&quot;</span>, error_ret);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (cmpt_index = 0; cmpt_index &lt; num_components; ++cmpt_index) {</div><div class="line"></div><div class="line">        component_attr.<a name="a53"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ad95df67b474d3f51629e0a6d0ee2537e">field_mask</a> = <a name="a54"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga246ded5e20aa09c590673c771c74b68ba25d44baf92c5c7673dbbf44de35fdc84">UCT_COMPONENT_ATTR_FIELD_MD_RESOURCE_COUNT</a>;</div><div class="line">        status = <a name="a55"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga437597d034328ce061df61647add1891">uct_component_query</a>(components[cmpt_index], &amp;component_attr);</div><div class="line">        CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;query component attributes&quot;</span>,</div><div class="line">                    release_component_list);</div><div class="line"></div><div class="line">        component_attr.<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ad95df67b474d3f51629e0a6d0ee2537e">field_mask</a> = <a name="a56"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga246ded5e20aa09c590673c771c74b68ba4ffc9f65e0b3d7cb07db745e7e61ba47">UCT_COMPONENT_ATTR_FIELD_MD_RESOURCES</a>;</div><div class="line">        component_attr.<a name="a57"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a75c51f7e16d827cc4c848016f5365404">md_resources</a> = alloca(<span class="keyword">sizeof</span>(*component_attr.<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a75c51f7e16d827cc4c848016f5365404">md_resources</a>) *</div><div class="line">                                             component_attr.<a name="a58"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a4add45e93acd44e434624726caaf9efb">md_resource_count</a>);</div><div class="line">        status = <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga437597d034328ce061df61647add1891">uct_component_query</a>(components[cmpt_index], &amp;component_attr);</div><div class="line">        CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;query for memory domain resources&quot;</span>,</div><div class="line">                    release_component_list);</div><div class="line"></div><div class="line">        iface_p-&gt;iface = NULL;</div><div class="line"></div><div class="line">        <span class="comment">/* Iterate through memory domain resources */</span></div><div class="line">        <span class="keywordflow">for</span> (md_index = 0; md_index &lt; component_attr.<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a4add45e93acd44e434624726caaf9efb">md_resource_count</a>; ++md_index) {</div><div class="line">            status = <a name="a59"></a><a class="code" href="group___u_c_t___m_d.html#ga8fd8d3ebc188c9016a179d5678c0a71f">uct_md_config_read</a>(components[cmpt_index], NULL, NULL,</div><div class="line">                                        &amp;md_config);</div><div class="line">            CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;read MD config&quot;</span>,</div><div class="line">                        release_component_list);</div><div class="line"></div><div class="line">            status = <a name="a60"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga6254b927d3bfcb9699dbf82f0987b9ce">uct_md_open</a>(components[cmpt_index],</div><div class="line">                                 component_attr.<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a75c51f7e16d827cc4c848016f5365404">md_resources</a>[md_index].<a name="a61"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a44245b18bf7151a4bde8cb4c0112f8cb">md_name</a>,</div><div class="line">                                 md_config, &amp;iface_p-&gt;md);</div><div class="line">            <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga951ea184730bc0b9cf659b1038e999a4">uct_config_release</a>(md_config);</div><div class="line">            CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;open memory domains&quot;</span>,</div><div class="line">                        release_component_list);</div><div class="line"></div><div class="line">            status = <a name="a62"></a><a class="code" href="group___u_c_t___m_d.html#gae7f6d3f902cff0370fe0f07f841898f1">uct_md_query</a>(iface_p-&gt;md, &amp;iface_p-&gt;md_attr);</div><div class="line">            CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;query iface&quot;</span>,</div><div class="line">                        close_md);</div><div class="line"></div><div class="line">            status = <a name="a63"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gae4572e36e60bf2665e59cc7ef04bb011">uct_md_query_tl_resources</a>(iface_p-&gt;md, &amp;tl_resources,</div><div class="line">                                               &amp;num_tl_resources);</div><div class="line">            CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;query transport resources&quot;</span>, close_md);</div><div class="line"></div><div class="line">            <span class="comment">/* Go through each available transport and find the proper name */</span></div><div class="line">            <span class="keywordflow">for</span> (tl_index = 0; tl_index &lt; num_tl_resources; ++tl_index) {</div><div class="line">                <span class="keywordflow">if</span> (!strcmp(cmd_args-&gt;dev_name, tl_resources[tl_index].dev_name) &amp;&amp;</div><div class="line">                    !strcmp(cmd_args-&gt;tl_name, tl_resources[tl_index].tl_name)) {</div><div class="line">                    <span class="keywordflow">if</span> (!(iface_p-&gt;md_attr.cap.reg_mem_types &amp; UCS_BIT(test_mem_type))) {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;Unsupported memory type %s by &quot;</span></div><div class="line">                                UCT_TL_RESOURCE_DESC_FMT<span class="stringliteral">&quot; on %s MD\n&quot;</span>,</div><div class="line">                                ucs_memory_type_names[test_mem_type],</div><div class="line">                                UCT_TL_RESOURCE_DESC_ARG(&amp;tl_resources[tl_index]),</div><div class="line">                                component_attr.<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a75c51f7e16d827cc4c848016f5365404">md_resources</a>[md_index].<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a44245b18bf7151a4bde8cb4c0112f8cb">md_name</a>);</div><div class="line">                        status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    status = init_iface(tl_resources[tl_index].dev_name,</div><div class="line">                                        tl_resources[tl_index].tl_name,</div><div class="line">                                        cmd_args-&gt;func_am_type, iface_p);</div><div class="line">                    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    fprintf(stdout, <span class="stringliteral">&quot;Using &quot;</span>UCT_TL_RESOURCE_DESC_FMT<span class="stringliteral">&quot;\n&quot;</span>,</div><div class="line">                            UCT_TL_RESOURCE_DESC_ARG(&amp;tl_resources[tl_index]));</div><div class="line">                    <span class="keywordflow">goto</span> release_tl_resources;</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">release_tl_resources:</div><div class="line">            <a name="a64"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga1edfeac896c9ca285ab11580c904b558">uct_release_tl_resource_list</a>(tl_resources);</div><div class="line">            <span class="keywordflow">if</span> ((status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) &amp;&amp;</div><div class="line">                (tl_index &lt; num_tl_resources)) {</div><div class="line">                <span class="keywordflow">goto</span> release_component_list;</div><div class="line">            }</div><div class="line"></div><div class="line">            tl_resources     = NULL;</div><div class="line">            num_tl_resources = 0;</div><div class="line">            <a name="a65"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac9ab18f8a48b07429c9987b584fe5574">uct_md_close</a>(iface_p-&gt;md);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;No supported (dev/tl) found (%s/%s)\n&quot;</span>,</div><div class="line">            cmd_args-&gt;dev_name, cmd_args-&gt;tl_name);</div><div class="line">    status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line"></div><div class="line">release_component_list:</div><div class="line">    <a name="a66"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gadd4eea4cf8e757f5ddd2e9edb1942dd0">uct_release_component_list</a>(components);</div><div class="line">error_ret:</div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">close_md:</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac9ab18f8a48b07429c9987b584fe5574">uct_md_close</a>(iface_p-&gt;md);</div><div class="line">    <span class="keywordflow">goto</span> release_component_list;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> print_err_usage()</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> func_template[] = <span class="stringliteral">&quot;  -%c      Select \&quot;%s\&quot; function to send the message%s\n&quot;</span>;</div><div class="line"></div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Usage: uct_hello_world [parameters]\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;UCT hello world client/server example utility\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\nParameters are:\n&quot;</span>);</div><div class="line">    fprintf(stderr, func_template, <span class="charliteral">&#39;i&#39;</span>, func_am_t_str(FUNC_AM_SHORT), <span class="stringliteral">&quot; (default)&quot;</span>);</div><div class="line">    fprintf(stderr, func_template, <span class="charliteral">&#39;b&#39;</span>, func_am_t_str(FUNC_AM_BCOPY), <span class="stringliteral">&quot;&quot;</span>);</div><div class="line">    fprintf(stderr, func_template, <span class="charliteral">&#39;z&#39;</span>, func_am_t_str(FUNC_AM_ZCOPY), <span class="stringliteral">&quot;&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  -d        Select device name\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  -t        Select transport layer\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  -n &lt;name&gt; Set node name or IP address &quot;</span></div><div class="line">            <span class="stringliteral">&quot;of the server (required for client and should be ignored &quot;</span></div><div class="line">            <span class="stringliteral">&quot;for server)\n&quot;</span>);</div><div class="line">    print_common_help();</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\nExample:\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  Server: uct_hello_world -d eth0 -t tcp\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;  Client: uct_hello_world -d eth0 -t tcp -n localhost\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> parse_cmd(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * <span class="keyword">const</span> argv[], cmd_args_t *args)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> c = 0, idx = 0;</div><div class="line"></div><div class="line">    assert(args);</div><div class="line">    memset(args, 0, <span class="keyword">sizeof</span>(*args));</div><div class="line"></div><div class="line">    <span class="comment">/* Defaults */</span></div><div class="line">    args-&gt;server_port   = 13337;</div><div class="line">    args-&gt;func_am_type  = FUNC_AM_SHORT;</div><div class="line">    args-&gt;test_strlen   = 16;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">&quot;ibzd:t:n:p:s:m:h&quot;</span>)) != -1) {</div><div class="line">        <span class="keywordflow">switch</span> (c) {</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:</div><div class="line">            args-&gt;func_am_type = FUNC_AM_SHORT;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:</div><div class="line">            args-&gt;func_am_type = FUNC_AM_BCOPY;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;z&#39;</span>:</div><div class="line">            args-&gt;func_am_type = FUNC_AM_ZCOPY;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:</div><div class="line">            args-&gt;dev_name = optarg;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div><div class="line">            args-&gt;tl_name = optarg;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:</div><div class="line">            args-&gt;server_name = optarg;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div><div class="line">            args-&gt;server_port = atoi(optarg);</div><div class="line">            <span class="keywordflow">if</span> (args-&gt;server_port &lt;= 0) {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Wrong server port number %d\n&quot;</span>,</div><div class="line">                        args-&gt;server_port);</div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:</div><div class="line">            args-&gt;test_strlen = atol(optarg);</div><div class="line">            <span class="keywordflow">if</span> (args-&gt;test_strlen &lt; 0) {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Wrong string size %ld\n&quot;</span>, args-&gt;test_strlen);</div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:</div><div class="line">            test_mem_type = parse_mem_type(optarg);</div><div class="line">            <span class="keywordflow">if</span> (test_mem_type == <a name="a67"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga5cfcc524f5dc586101a3e7caff8d982da6105aba9983dc25cbf7cbf4d03f655d7">UCS_MEMORY_TYPE_LAST</a>) {</div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">return</span> print_err_usage();</div><div class="line">        }</div><div class="line">    }</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;INFO: UCT_HELLO_WORLD AM function = %s server = %s port = %d\n&quot;</span>,</div><div class="line">            func_am_t_str(args-&gt;func_am_type), args-&gt;server_name,</div><div class="line">            args-&gt;server_port);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (idx = optind; idx &lt; argc; idx++) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;WARNING: Non-option argument %s\n&quot;</span>, argv[idx]);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (args-&gt;dev_name == NULL) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;WARNING: device is not set\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> print_err_usage();</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (args-&gt;tl_name == NULL) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;WARNING: transport layer is not set\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> print_err_usage();</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* The caller is responsible to free *rbuf */</span></div><div class="line"><span class="keywordtype">int</span> sendrecv(<span class="keywordtype">int</span> sock, <span class="keyword">const</span> <span class="keywordtype">void</span> *sbuf, <span class="keywordtype">size_t</span> slen, <span class="keywordtype">void</span> **rbuf)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line">    <span class="keywordtype">size_t</span> rlen = 0;</div><div class="line">    *rbuf = NULL;</div><div class="line"></div><div class="line">    ret = send(sock, &amp;slen, <span class="keyword">sizeof</span>(slen), 0);</div><div class="line">    <span class="keywordflow">if</span> ((ret &lt; 0) || (ret != <span class="keyword">sizeof</span>(slen))) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to send buffer length\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    ret = send(sock, sbuf, slen, 0);</div><div class="line">    <span class="keywordflow">if</span> (ret != (<span class="keywordtype">int</span>)slen) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to send buffer, return value %d\n&quot;</span>, ret);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    ret = recv(sock, &amp;rlen, <span class="keyword">sizeof</span>(rlen), MSG_WAITALL);</div><div class="line">    <span class="keywordflow">if</span> ((ret != <span class="keyword">sizeof</span>(rlen)) || (rlen &gt; (SIZE_MAX / 2))) {</div><div class="line">        fprintf(stderr,</div><div class="line">                <span class="stringliteral">&quot;failed to receive device address length, return value %d\n&quot;</span>,</div><div class="line">                ret);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    *rbuf = calloc(1, rlen);</div><div class="line">    <span class="keywordflow">if</span> (!*rbuf) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to allocate receive buffer\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    ret = recv(sock, *rbuf, rlen, MSG_WAITALL);</div><div class="line">    <span class="keywordflow">if</span> (ret != (<span class="keywordtype">int</span>)rlen) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to receive device address, return value %d\n&quot;</span>,</div><div class="line">                ret);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac88423ede47b1ecaf895996971cfdf53">uct_device_addr_t</a>   *peer_dev   = NULL;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga96d01980a33064e85158b9028073e96c">uct_iface_addr_t</a>    *peer_iface = NULL;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga808816ad1373f05b9ed7f3432d9f78c6">uct_ep_addr_t</a>       *own_ep     = NULL;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga808816ad1373f05b9ed7f3432d9f78c6">uct_ep_addr_t</a>       *peer_ep    = NULL;</div><div class="line">    uint8_t             <span class="keywordtype">id</span>          = 0;</div><div class="line">    <span class="keywordtype">int</span>                 oob_sock    = -1;  <span class="comment">/* OOB connection socket */</span></div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>        status      = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>; <span class="comment">/* status codes for UCS */</span></div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac88423ede47b1ecaf895996971cfdf53">uct_device_addr_t</a>   *own_dev;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga96d01980a33064e85158b9028073e96c">uct_iface_addr_t</a>    *own_iface;</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gae7298a2b6fdb0e7771868459b10d6b20">uct_ep_h</a>            ep;                   <span class="comment">/* Remote endpoint */</span></div><div class="line">    ucs_async_context_t *async;               <span class="comment">/* Async event context manages</span></div><div class="line"><span class="comment">                                                 times and fd notifications */</span></div><div class="line">    cmd_args_t          cmd_args;</div><div class="line">    iface_info_t        if_info;</div><div class="line">    <a name="_a68"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#structuct__ep__params">uct_ep_params_t</a>     ep_params;</div><div class="line">    <span class="keywordtype">int</span>                 res;</div><div class="line"></div><div class="line">    <span class="comment">/* Parse the command line */</span></div><div class="line">    <span class="keywordflow">if</span> (parse_cmd(argc, argv, &amp;cmd_args)) {</div><div class="line">        status = <a name="a69"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558ab5a5c5278c83f957a096444de28db597">UCS_ERR_INVALID_PARAM</a>;</div><div class="line">        <span class="keywordflow">goto</span> out;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize context</span></div><div class="line"><span class="comment">     * It is better to use different contexts for different workers */</span></div><div class="line">    status = <a name="a70"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga8c3ad862fef1d35af708628d778a5a5b">ucs_async_context_create</a>(UCS_ASYNC_MODE_THREAD_SPINLOCK, &amp;async);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;init async context&quot;</span>, out);</div><div class="line"></div><div class="line">    <span class="comment">/* Create a worker object */</span></div><div class="line">    status = <a name="a71"></a><a class="code" href="group___u_c_t___c_o_n_t_e_x_t.html#ga6f21b4dd1dc16d55f4a8e6bf65f8757f">uct_worker_create</a>(async, <a name="a72"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga40e9f363c389e702ad9920f5d52525ceabc2f71e39a3527f7abe6a1c47f0a5a25">UCS_THREAD_MODE_SINGLE</a>, &amp;if_info.worker);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;create worker&quot;</span>, out_cleanup_async);</div><div class="line"></div><div class="line">    <span class="comment">/* Search for the desired transport */</span></div><div class="line">    status = dev_tl_lookup(&amp;cmd_args, &amp;if_info);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;find supported device and transport&quot;</span>,</div><div class="line">                out_destroy_worker);</div><div class="line"></div><div class="line">    own_dev = (<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac88423ede47b1ecaf895996971cfdf53">uct_device_addr_t</a>*)calloc(1, if_info.iface_attr.device_addr_len);</div><div class="line">    CHKERR_JUMP(NULL == own_dev, <span class="stringliteral">&quot;allocate memory for dev addr&quot;</span>,</div><div class="line">                out_destroy_iface);</div><div class="line"></div><div class="line">    own_iface = (<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga96d01980a33064e85158b9028073e96c">uct_iface_addr_t</a>*)calloc(1, if_info.iface_attr.iface_addr_len);</div><div class="line">    CHKERR_JUMP(NULL == own_iface, <span class="stringliteral">&quot;allocate memory for if addr&quot;</span>,</div><div class="line">                out_free_dev_addrs);</div><div class="line"></div><div class="line">    <span class="comment">/* Get device address */</span></div><div class="line">    status = <a name="a73"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga67f64f9b1971622ab8e7c8410cc5ab44">uct_iface_get_device_address</a>(if_info.iface, own_dev);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;get device address&quot;</span>, out_free_if_addrs);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (cmd_args.server_name) {</div><div class="line">        oob_sock = client_connect(cmd_args.server_name, cmd_args.server_port);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        oob_sock = server_connect(cmd_args.server_port);</div><div class="line">    }</div><div class="line">    CHKERR_ACTION(oob_sock &lt; 0, <span class="stringliteral">&quot;OOB connect&quot;</span>,</div><div class="line">                  status = <a name="a74"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558aaaf39ceea715057fdec5736443e0265b">UCS_ERR_IO_ERROR</a>; <span class="keywordflow">goto</span> out_close_oob_sock);</div><div class="line"></div><div class="line">    res = sendrecv(oob_sock, own_dev, if_info.iface_attr.device_addr_len,</div><div class="line">                   (<span class="keywordtype">void</span> **)&amp;peer_dev);</div><div class="line">    CHKERR_ACTION(0 != res, <span class="stringliteral">&quot;device exchange&quot;</span>,</div><div class="line">                  status = <a name="a75"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1bbd2445646883a1ef758fe2ef75e586">UCS_ERR_NO_MESSAGE</a>; <span class="keywordflow">goto</span> out_close_oob_sock);</div><div class="line"></div><div class="line">    status = (<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>)<a name="a76"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gadf8829d8c85620cbc1ddfc0f3e8ec9a8">uct_iface_is_reachable</a>(if_info.iface, peer_dev, NULL);</div><div class="line">    CHKERR_JUMP(0 == status, <span class="stringliteral">&quot;reach the peer&quot;</span>, out_close_oob_sock);</div><div class="line"></div><div class="line">    <span class="comment">/* Get interface address */</span></div><div class="line">    <span class="keywordflow">if</span> (if_info.iface_attr.cap.flags &amp; <a name="a77"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e___i_f_a_c_e___c_a_p.html#gac56a560766f8c50bef684e0e6b4efd18">UCT_IFACE_FLAG_CONNECT_TO_IFACE</a>) {</div><div class="line">        status = <a name="a78"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga7da50f02f6cfaaf16f11c620fba9f3b8">uct_iface_get_address</a>(if_info.iface, own_iface);</div><div class="line">        CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;get interface address&quot;</span>,</div><div class="line">                    out_close_oob_sock);</div><div class="line"></div><div class="line">        status = (<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>)sendrecv(oob_sock, own_iface, if_info.iface_attr.iface_addr_len,</div><div class="line">                                        (<span class="keywordtype">void</span> **)&amp;peer_iface);</div><div class="line">        CHKERR_JUMP(0 != status, <span class="stringliteral">&quot;ifaces exchange&quot;</span>, out_close_oob_sock);</div><div class="line">    }</div><div class="line"></div><div class="line">    ep_params.<a name="a79"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a9c1ea4678d33fd3f741856135ad61d23">field_mask</a> = <a name="a80"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga8e76f363d8805669fb5371b404c5658ba082065ffa8866740ca6418a9c38b503d">UCT_EP_PARAM_FIELD_IFACE</a>;</div><div class="line">    ep_params.<a name="a81"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a21e3628c5ffcafcdeb732f4f9687aa30">iface</a>      = if_info.iface;</div><div class="line">    <span class="keywordflow">if</span> (if_info.iface_attr.cap.flags &amp; <a name="a82"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e___i_f_a_c_e___c_a_p.html#ga598f1ae11f9ed8cfed2f6c04bbb0bfe8">UCT_IFACE_FLAG_CONNECT_TO_EP</a>) {</div><div class="line">        own_ep = (<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga808816ad1373f05b9ed7f3432d9f78c6">uct_ep_addr_t</a>*)calloc(1, if_info.iface_attr.ep_addr_len);</div><div class="line">        CHKERR_ACTION(NULL == own_ep, <span class="stringliteral">&quot;allocate memory for ep addrs&quot;</span>,</div><div class="line">                      status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a9919ffd4eaf870612c4aa63df65ae0a6">UCS_ERR_NO_MEMORY</a>; <span class="keywordflow">goto</span> out_close_oob_sock);</div><div class="line"></div><div class="line">        <span class="comment">/* Create new endpoint */</span></div><div class="line">        status = <a name="a83"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga0b2d38bde2651977c2b476e6e8866acc">uct_ep_create</a>(&amp;ep_params, &amp;ep);</div><div class="line">        CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;create endpoint&quot;</span>, out_free_ep_addrs);</div><div class="line"></div><div class="line">        <span class="comment">/* Get endpoint address */</span></div><div class="line">        status = <a name="a84"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga23773d9d87524cfa6dc6c2d1e094d487">uct_ep_get_address</a>(ep, own_ep);</div><div class="line">        CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;get endpoint address&quot;</span>, out_free_ep);</div><div class="line"></div><div class="line">        status = (<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>)sendrecv(oob_sock, own_ep, if_info.iface_attr.ep_addr_len,</div><div class="line">                                        (<span class="keywordtype">void</span> **)&amp;peer_ep);</div><div class="line">        CHKERR_JUMP(0 != status, <span class="stringliteral">&quot;EPs exchange&quot;</span>, out_free_ep);</div><div class="line"></div><div class="line">        <span class="comment">/* Connect endpoint to a remote endpoint */</span></div><div class="line">        status = <a name="a85"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga371685403748eb72784fdcb17f9e4bdf">uct_ep_connect_to_ep</a>(ep, peer_dev, peer_ep);</div><div class="line">        <span class="keywordflow">if</span> (barrier(oob_sock)) {</div><div class="line">            status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558aaaf39ceea715057fdec5736443e0265b">UCS_ERR_IO_ERROR</a>;</div><div class="line">            <span class="keywordflow">goto</span> out_free_ep;</div><div class="line">        }</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (if_info.iface_attr.cap.flags &amp; <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e___i_f_a_c_e___c_a_p.html#gac56a560766f8c50bef684e0e6b4efd18">UCT_IFACE_FLAG_CONNECT_TO_IFACE</a>) {</div><div class="line">        <span class="comment">/* Create an endpoint which is connected to a remote interface */</span></div><div class="line">        ep_params.<a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a9c1ea4678d33fd3f741856135ad61d23">field_mask</a> |= <a name="a86"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga8e76f363d8805669fb5371b404c5658ba14fb24fafcf9fdd0418a5dd348ab828c">UCT_EP_PARAM_FIELD_DEV_ADDR</a> |</div><div class="line">                                <a name="a87"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gga8e76f363d8805669fb5371b404c5658baef938215a002d0b59812c737db0a965d">UCT_EP_PARAM_FIELD_IFACE_ADDR</a>;</div><div class="line">        ep_params.<a name="a88"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#a273d48d73a6813f2fe097026d739e9d9">dev_addr</a>    = peer_dev;</div><div class="line">        ep_params.<a name="a89"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ae8c9ada98be19a83ab9cd2af30203d5f">iface_addr</a>  = peer_iface;</div><div class="line">        status = <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga0b2d38bde2651977c2b476e6e8866acc">uct_ep_create</a>(&amp;ep_params, &amp;ep);</div><div class="line">        CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;create endpoint&quot;</span>, out_free_ep_addrs);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">        <span class="keywordflow">goto</span> out_free_ep_addrs;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (cmd_args.test_strlen &gt; func_am_max_size(cmd_args.func_am_type, &amp;if_info.iface_attr)) {</div><div class="line">        status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>;</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Test string is too long: %ld, max supported: %lu\n&quot;</span>,</div><div class="line">                cmd_args.test_strlen,</div><div class="line">                func_am_max_size(cmd_args.func_am_type, &amp;if_info.iface_attr));</div><div class="line">        <span class="keywordflow">goto</span> out_free_ep;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Set active message handler */</span></div><div class="line">    status = <a name="a90"></a><a class="code" href="group___u_c_t___a_m.html#ga81dd3f74f8dc8c2c950d932fca0f799e">uct_iface_set_am_handler</a>(if_info.iface, <span class="keywordtype">id</span>, hello_world,</div><div class="line">                                      &amp;cmd_args.func_am_type, 0);</div><div class="line">    CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;set callback&quot;</span>, out_free_ep);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (cmd_args.server_name) {</div><div class="line">        <span class="keywordtype">char</span> *str = (<span class="keywordtype">char</span> *)mem_type_malloc(cmd_args.test_strlen);</div><div class="line">        CHKERR_ACTION(str == NULL, <span class="stringliteral">&quot;allocate memory&quot;</span>,</div><div class="line">                      status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a9919ffd4eaf870612c4aa63df65ae0a6">UCS_ERR_NO_MEMORY</a>; <span class="keywordflow">goto</span> out_free_ep);</div><div class="line">        res = generate_test_string(str, cmd_args.test_strlen);</div><div class="line">        CHKERR_ACTION(res &lt; 0, <span class="stringliteral">&quot;generate test string&quot;</span>,</div><div class="line">                      status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a9919ffd4eaf870612c4aa63df65ae0a6">UCS_ERR_NO_MEMORY</a>; <span class="keywordflow">goto</span> out_free_ep);</div><div class="line"></div><div class="line">        <span class="comment">/* Send active message to remote endpoint */</span></div><div class="line">        <span class="keywordflow">if</span> (cmd_args.func_am_type == FUNC_AM_SHORT) {</div><div class="line">            status = do_am_short(&amp;if_info, ep, <span class="keywordtype">id</span>, &amp;cmd_args, str);</div><div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_args.func_am_type == FUNC_AM_BCOPY) {</div><div class="line">            status = do_am_bcopy(&amp;if_info, ep, <span class="keywordtype">id</span>, &amp;cmd_args, str);</div><div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_args.func_am_type == FUNC_AM_ZCOPY) {</div><div class="line">            status = do_am_zcopy(&amp;if_info, ep, <span class="keywordtype">id</span>, &amp;cmd_args, str);</div><div class="line">        }</div><div class="line"></div><div class="line">        mem_type_free(str);</div><div class="line">        CHKERR_JUMP(<a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> != status, <span class="stringliteral">&quot;send active msg&quot;</span>, out_free_ep);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        recv_desc_t *rdesc;</div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> (desc_holder == NULL) {</div><div class="line">            <span class="comment">/* Explicitly progress any outstanding active message requests */</span></div><div class="line">            <a class="code" href="group___u_c_t___c_o_n_t_e_x_t.html#ga4ec9fae48afd24d7fa7c5537e76b54e5">uct_worker_progress</a>(if_info.worker);</div><div class="line">        }</div><div class="line"></div><div class="line">        rdesc = desc_holder;</div><div class="line">        print_strings(<span class="stringliteral">&quot;main&quot;</span>, func_am_t_str(cmd_args.func_am_type),</div><div class="line">                      (<span class="keywordtype">char</span> *)(rdesc + 1), cmd_args.test_strlen);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (rdesc-&gt;is_uct_desc) {</div><div class="line">            <span class="comment">/* Release descriptor because callback returns UCS_INPROGRESS */</span></div><div class="line">            <a name="a91"></a><a class="code" href="group___u_c_t___a_m.html#gac894ed0c24a3481f316945a462d67921">uct_iface_release_desc</a>(rdesc);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            free(rdesc);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (barrier(oob_sock)) {</div><div class="line">        status = <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558aaaf39ceea715057fdec5736443e0265b">UCS_ERR_IO_ERROR</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">out_free_ep:</div><div class="line">    <a name="a92"></a><a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac7d6537c7cdacdf24afeafe9c0085163">uct_ep_destroy</a>(ep);</div><div class="line">out_free_ep_addrs:</div><div class="line">    free(own_ep);</div><div class="line">    free(peer_ep);</div><div class="line">out_close_oob_sock:</div><div class="line">    close(oob_sock);</div><div class="line">out_free_if_addrs:</div><div class="line">    free(own_iface);</div><div class="line">    free(peer_iface);</div><div class="line">out_free_dev_addrs:</div><div class="line">    free(own_dev);</div><div class="line">    free(peer_dev);</div><div class="line">out_destroy_iface:</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#ga748bd92ba4e62fd86c6b002f9198e2aa">uct_iface_close</a>(if_info.iface);</div><div class="line">    <a class="code" href="group___u_c_t___r_e_s_o_u_r_c_e.html#gac9ab18f8a48b07429c9987b584fe5574">uct_md_close</a>(if_info.md);</div><div class="line">out_destroy_worker:</div><div class="line">    <a name="a93"></a><a class="code" href="group___u_c_t___c_o_n_t_e_x_t.html#ga22608452cb78bb1d3c9253860025c4fd">uct_worker_destroy</a>(if_info.worker);</div><div class="line">out_cleanup_async:</div><div class="line">    <a name="a94"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga65db07fbee18ab2bd46a738c89ccc8f7">ucs_async_context_destroy</a>(async);</div><div class="line">out:</div><div class="line">    <span class="keywordflow">return</span> (status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>) ? <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a> : status;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Aug 1 2021 15:26:04 for UCX by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
