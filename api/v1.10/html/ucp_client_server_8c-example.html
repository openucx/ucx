<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UCX: ucp_client_server.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="UCX_Logo_80x80.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UCX
   &#160;<span id="projectnumber">1.10</span>
   </div>
   <div id="projectbrief">Unified Communication X</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ucp_client_server_8c-example.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ucp_client_server.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>UCP client / server example using different APIs (tag, stream, am) utility.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * UCP client - server example utility</span></div><div class="line"><span class="comment"> * -----------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Server side:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *    ./ucp_client_server</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Client side:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *    ./ucp_client_server -a &lt;server-ip&gt;</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Notes:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *    - The server will listen to incoming connection requests on INADDR_ANY.</span></div><div class="line"><span class="comment"> *    - The client needs to pass the IP address of the server side to connect to</span></div><div class="line"><span class="comment"> *      as an argument to the test.</span></div><div class="line"><span class="comment"> *    - Currently, the passed IP needs to be an IPoIB or a RoCE address.</span></div><div class="line"><span class="comment"> *    - The port which the server side would listen on can be modified with the</span></div><div class="line"><span class="comment"> *      &#39;-p&#39; option and should be used on both sides. The default port to use is</span></div><div class="line"><span class="comment"> *      13337.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;ucp/api/ucp.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span>    <span class="comment">/* memset */</span></div><div class="line"><span class="preprocessor">#include &lt;arpa/inet.h&gt;</span> <span class="comment">/* inet_addr */</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span>    <span class="comment">/* getopt */</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span>    <span class="comment">/* atoi */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define TEST_STRING_LEN        sizeof(test_message)</span></div><div class="line"><span class="preprocessor">#define DEFAULT_PORT           13337</span></div><div class="line"><span class="preprocessor">#define IP_STRING_LEN          50</span></div><div class="line"><span class="preprocessor">#define PORT_STRING_LEN        8</span></div><div class="line"><span class="preprocessor">#define TAG                    0xCAFE</span></div><div class="line"><span class="preprocessor">#define COMM_TYPE_DEFAULT      &quot;STREAM&quot;</span></div><div class="line"><span class="preprocessor">#define PRINT_INTERVAL         2000</span></div><div class="line"><span class="preprocessor">#define DEFAULT_NUM_ITERATIONS 1</span></div><div class="line"><span class="preprocessor">#define TEST_AM_ID             0</span></div><div class="line"></div><div class="line"><span class="keyword">const</span>  <span class="keywordtype">char</span> test_message[]           = <span class="stringliteral">&quot;UCX Client-Server Hello World&quot;</span>;</div><div class="line"><span class="keyword">static</span> uint16_t server_port          = DEFAULT_PORT;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> num_iterations            = DEFAULT_NUM_ITERATIONS;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div><div class="line">    CLIENT_SERVER_SEND_RECV_STREAM  = UCS_BIT(0),</div><div class="line">    CLIENT_SERVER_SEND_RECV_TAG     = UCS_BIT(1),</div><div class="line">    CLIENT_SERVER_SEND_RECV_AM      = UCS_BIT(2),</div><div class="line">    CLIENT_SERVER_SEND_RECV_DEFAULT = CLIENT_SERVER_SEND_RECV_STREAM</div><div class="line">} send_recv_type_t;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>ucx_server_ctx {</div><div class="line">    <span class="keyword">volatile</span> <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga200570bfa7d3a8b50b2a074aaa22d2ed">ucp_conn_request_h</a> conn_request;</div><div class="line">    <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#gac0496f7102c43cf339cc760b9e5724a2">ucp_listener_h</a>              listener;</div><div class="line">} ucx_server_ctx_t;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>test_req {</div><div class="line">    <span class="keywordtype">int</span> complete;</div><div class="line">} test_req_t;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div><div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">int</span> complete;</div><div class="line">    <span class="keywordtype">int</span>          is_rndv;</div><div class="line">    <span class="keywordtype">void</span>         *desc;</div><div class="line">    <span class="keywordtype">void</span>         *recv_buf;</div><div class="line">} am_data_desc = {0, 0, NULL, NULL};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> tag_recv_cb(<span class="keywordtype">void</span> *request, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status,</div><div class="line">                        <span class="keyword">const</span> <a name="_a0"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__tag__recv__info">ucp_tag_recv_info_t</a> *info, <span class="keywordtype">void</span> *user_data)</div><div class="line">{</div><div class="line">    test_req_t *ctx = user_data;</div><div class="line"></div><div class="line">    ctx-&gt;complete = 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">stream_recv_cb(<span class="keywordtype">void</span> *request, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status, <span class="keywordtype">size_t</span> length,</div><div class="line">               <span class="keywordtype">void</span> *user_data)</div><div class="line">{</div><div class="line">    test_req_t *ctx = user_data;</div><div class="line"></div><div class="line">    ctx-&gt;complete = 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> am_recv_cb(<span class="keywordtype">void</span> *request, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status, <span class="keywordtype">size_t</span> length,</div><div class="line">                       <span class="keywordtype">void</span> *user_data)</div><div class="line">{</div><div class="line">    test_req_t *ctx = user_data;</div><div class="line"></div><div class="line">    ctx-&gt;complete = 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> send_cb(<span class="keywordtype">void</span> *request, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status, <span class="keywordtype">void</span> *user_data)</div><div class="line">{</div><div class="line">    test_req_t *ctx = user_data;</div><div class="line"></div><div class="line">    ctx-&gt;complete = 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> err_cb(<span class="keywordtype">void</span> *arg, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep, <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;error handling callback was invoked with status %d (%s)\n&quot;</span>,</div><div class="line">           status, ucs_status_string(status));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> set_listen_addr(<span class="keyword">const</span> <span class="keywordtype">char</span> *address_str, <span class="keyword">struct</span> sockaddr_in *listen_addr)</div><div class="line">{</div><div class="line">    <span class="comment">/* The server will listen on INADDR_ANY */</span></div><div class="line">    memset(listen_addr, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in));</div><div class="line">    listen_addr-&gt;sin_family      = AF_INET;</div><div class="line">    listen_addr-&gt;sin_addr.s_addr = (address_str) ? inet_addr(address_str) : INADDR_ANY;</div><div class="line">    listen_addr-&gt;sin_port        = htons(server_port);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> set_connect_addr(<span class="keyword">const</span> <span class="keywordtype">char</span> *address_str, <span class="keyword">struct</span> sockaddr_in *connect_addr)</div><div class="line">{</div><div class="line">    memset(connect_addr, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in));</div><div class="line">    connect_addr-&gt;sin_family      = AF_INET;</div><div class="line">    connect_addr-&gt;sin_addr.s_addr = inet_addr(address_str);</div><div class="line">    connect_addr-&gt;sin_port        = htons(server_port);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> start_client(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <span class="keyword">const</span> <span class="keywordtype">char</span> *ip,</div><div class="line">                                 <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> *client_ep)</div><div class="line">{</div><div class="line">    <a name="_a1"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#structucp__ep__params">ucp_ep_params_t</a> ep_params;</div><div class="line">    <span class="keyword">struct </span>sockaddr_in connect_addr;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line"></div><div class="line">    set_connect_addr(ip, &amp;connect_addr);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Endpoint field mask bits:</span></div><div class="line"><span class="comment">     * UCP_EP_PARAM_FIELD_FLAGS             - Use the value of the &#39;flags&#39; field.</span></div><div class="line"><span class="comment">     * UCP_EP_PARAM_FIELD_SOCK_ADDR         - Use a remote sockaddr to connect</span></div><div class="line"><span class="comment">     *                                        to the remote peer.</span></div><div class="line"><span class="comment">     * UCP_EP_PARAM_FIELD_ERR_HANDLING_MODE - Error handling mode - this flag</span></div><div class="line"><span class="comment">     *                                        is temporarily required since the</span></div><div class="line"><span class="comment">     *                                        endpoint will be closed with</span></div><div class="line"><span class="comment">     *                                        UCP_EP_CLOSE_MODE_FORCE which</span></div><div class="line"><span class="comment">     *                                        requires this mode.</span></div><div class="line"><span class="comment">     *                                        Once UCP_EP_CLOSE_MODE_FORCE is</span></div><div class="line"><span class="comment">     *                                        removed, the error handling mode</span></div><div class="line"><span class="comment">     *                                        will be removed.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ep_params.<a name="a2"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ab7b3f3ba1d402a621b8ea708dcf2387b">field_mask</a>       = <a name="a3"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60a1b53a3d4eaee470bcb3e23c60f1f7794">UCP_EP_PARAM_FIELD_FLAGS</a>       |</div><div class="line">                                 <a name="a4"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60a8149dfb8648b2b248825020c63449a80">UCP_EP_PARAM_FIELD_SOCK_ADDR</a>   |</div><div class="line">                                 <a name="a5"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60adc6619f5e4bf3f68190f918ee064036d">UCP_EP_PARAM_FIELD_ERR_HANDLER</a> |</div><div class="line">                                 <a name="a6"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60a1b0e70c12efabe6a2cab3c9bc66db340">UCP_EP_PARAM_FIELD_ERR_HANDLING_MODE</a>;</div><div class="line">    ep_params.<a name="a7"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#a50ce29893509695caa5b70ab4525a4d6">err_mode</a>         = <a name="a8"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#gga7c69a28724d5ae3e49490e23e64df167aa31630259732e700b6ce0fe612cf0a6f">UCP_ERR_HANDLING_MODE_PEER</a>;</div><div class="line">    ep_params.<a name="a9"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aaf329de9e2b45311099cee8c9df43a20">err_handler</a>.<a name="a10"></a><a class="code" href="group___u_c_p___c_o_m_m.html#a0bf3f446a1821a62dd3a300584792e33">cb</a>   = err_cb;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aaf329de9e2b45311099cee8c9df43a20">err_handler</a>.<a name="a11"></a><a class="code" href="group___u_c_p___c_o_m_m.html#a7e49e1843e1adab5561e5fc2b2e1afb1">arg</a>  = NULL;</div><div class="line">    ep_params.<a name="a12"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#a9bb65021187347fe311535857e19e6c3">flags</a>            = <a name="a13"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#gga4a1f422dc1e81495b4aee1da8939459fad42871a591a0a34bccf5c8203a0b32bb">UCP_EP_PARAMS_FLAGS_CLIENT_SERVER</a>;</div><div class="line">    ep_params.<a name="a14"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aa23fd9a6a092266371258bd285c96816">sockaddr</a>.<a name="a15"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#a6294db86dc9327058b8a31cb4af87edb">addr</a>    = (<span class="keyword">struct </span>sockaddr*)&amp;connect_addr;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aa23fd9a6a092266371258bd285c96816">sockaddr</a>.<a name="a16"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ac86eaa6362c3345d05c75bb4508ff2f1">addrlen</a> = <span class="keyword">sizeof</span>(connect_addr);</div><div class="line"></div><div class="line">    status = <a name="a17"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga6cc5ffb2ba1b0ccd510848de0a779f7b">ucp_ep_create</a>(ucp_worker, &amp;ep_params, client_ep);</div><div class="line">    <span class="keywordflow">if</span> (status != <a name="a18"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to connect to %s (%s)\n&quot;</span>, ip, ucs_status_string(status));</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_result(<span class="keywordtype">int</span> is_server, <span class="keywordtype">char</span> *recv_message, <span class="keywordtype">int</span> current_iter)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (is_server) {</div><div class="line">        printf(<span class="stringliteral">&quot;Server: iteration #%d\n&quot;</span>, (current_iter + 1));</div><div class="line">        printf(<span class="stringliteral">&quot;UCX data message was received\n&quot;</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;\n\n----- UCP TEST SUCCESS -------\n\n&quot;</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;%s&quot;</span>, recv_message);</div><div class="line">        printf(<span class="stringliteral">&quot;\n\n------------------------------\n\n&quot;</span>);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        printf(<span class="stringliteral">&quot;Client: iteration #%d\n&quot;</span>, (current_iter + 1));</div><div class="line">        printf(<span class="stringliteral">&quot;\n\n-----------------------------------------\n\n&quot;</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;Client sent message: \n%s.\nlength: %ld\n&quot;</span>,</div><div class="line">               test_message, TEST_STRING_LEN);</div><div class="line">        printf(<span class="stringliteral">&quot;\n-----------------------------------------\n\n&quot;</span>);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> request_wait(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <span class="keywordtype">void</span> *request,</div><div class="line">                                 test_req_t *ctx)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line"></div><div class="line">    <span class="comment">/* if operation was completed immediately */</span></div><div class="line">    <span class="keywordflow">if</span> (request == NULL) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="keywordflow">if</span> (UCS_PTR_IS_ERR(request)) {</div><div class="line">        <span class="keywordflow">return</span> UCS_PTR_STATUS(request);</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="keywordflow">while</span> (ctx-&gt;complete == 0) {</div><div class="line">        <a name="a19"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line">    }</div><div class="line">    status = <a name="a20"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gae082ad7af428645ebe6e469d3d06a757">ucp_request_check_status</a>(request);</div><div class="line"></div><div class="line">    <a name="a21"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ga0e8e46f5953d464382b21edef3ec9994">ucp_request_free</a>(request);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> request_finalize(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, test_req_t *request,</div><div class="line">                            test_req_t *ctx, <span class="keywordtype">int</span> is_server,</div><div class="line">                            <span class="keywordtype">char</span> *recv_message, <span class="keywordtype">int</span> current_iter)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    status = request_wait(ucp_worker, request, ctx);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;unable to %s UCX message (%s)\n&quot;</span>,</div><div class="line">                is_server ? <span class="stringliteral">&quot;receive&quot;</span>: <span class="stringliteral">&quot;send&quot;</span>, ucs_status_string(status));</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Print the output of the first, last and every PRINT_INTERVAL iteration */</span></div><div class="line">    <span class="keywordflow">if</span> ((current_iter == 0) || (current_iter == (num_iterations - 1)) ||</div><div class="line">        !((current_iter + 1) % (PRINT_INTERVAL))) {</div><div class="line">        print_result(is_server, recv_message, current_iter);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> send_recv_stream(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep, <span class="keywordtype">int</span> is_server,</div><div class="line">                            <span class="keywordtype">int</span> current_iter)</div><div class="line">{</div><div class="line">    <span class="keywordtype">char</span> recv_message[TEST_STRING_LEN]= <span class="stringliteral">&quot;&quot;</span>;</div><div class="line">    <a name="_a22"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__request__param__t">ucp_request_param_t</a> param;</div><div class="line">    test_req_t *request;</div><div class="line">    <span class="keywordtype">size_t</span> length;</div><div class="line">    test_req_t ctx;</div><div class="line"></div><div class="line">    ctx.complete = 0;</div><div class="line">    param.<a name="a23"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a> = <a name="a24"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a73e3a6e8b96b37ec1b0764e67dd13602">UCP_OP_ATTR_FIELD_CALLBACK</a> |</div><div class="line">                         <a name="a25"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610af6f932f15331fe7c9efacbfe2578e5ec">UCP_OP_ATTR_FIELD_USER_DATA</a>;</div><div class="line">    param.<a name="a26"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#aa9092d65a2e4e55368ca4f88775c190b">user_data</a>    = &amp;ctx;</div><div class="line">    <span class="keywordflow">if</span> (!is_server) {</div><div class="line">        <span class="comment">/* Client sends a message to the server using the stream API */</span></div><div class="line">        param.<a name="a27"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.send = send_cb;</div><div class="line">        request       = <a name="a28"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gae9fe6efe6b05e4e78f58bee68c68b252">ucp_stream_send_nbx</a>(ep, test_message, TEST_STRING_LEN,</div><div class="line">                                            &amp;param);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* Server receives a message from the client using the stream API */</span></div><div class="line">        param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a>  |= <a name="a29"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a2f2586686e21b2700fd7cd4a8efb5a1b">UCP_OP_ATTR_FIELD_FLAGS</a>;</div><div class="line">        param.<a name="a30"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a55a8ff2559470c5def6077a86ee9d898">flags</a>          = <a name="a31"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ggab471a9c7ab815e3d3ad7af80253f5cc2a5fb4ed4f8009d969ea9a8b3f3542424c">UCP_STREAM_RECV_FLAG_WAITALL</a>;</div><div class="line">        param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.recv_stream = stream_recv_cb;</div><div class="line">        request              = <a name="a32"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ga30494ce33e63823c81c2c5b3656d25c3">ucp_stream_recv_nbx</a>(ep, &amp;recv_message,</div><div class="line">                                                   TEST_STRING_LEN,</div><div class="line">                                                   &amp;length, &amp;param);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> request_finalize(ucp_worker, request, &amp;ctx, is_server,</div><div class="line">                            recv_message, current_iter);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> send_recv_tag(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep, <span class="keywordtype">int</span> is_server,</div><div class="line">                         <span class="keywordtype">int</span> current_iter)</div><div class="line">{</div><div class="line">    <span class="keywordtype">char</span> recv_message[TEST_STRING_LEN]= <span class="stringliteral">&quot;&quot;</span>;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__request__param__t">ucp_request_param_t</a> param;</div><div class="line">    <span class="keywordtype">void</span> *request;</div><div class="line">    test_req_t ctx;</div><div class="line"></div><div class="line">    ctx.complete = 0;</div><div class="line">    param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a> = <a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a73e3a6e8b96b37ec1b0764e67dd13602">UCP_OP_ATTR_FIELD_CALLBACK</a> |</div><div class="line">                         <a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610af6f932f15331fe7c9efacbfe2578e5ec">UCP_OP_ATTR_FIELD_USER_DATA</a>;</div><div class="line">    param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#aa9092d65a2e4e55368ca4f88775c190b">user_data</a>    = &amp;ctx;</div><div class="line">    <span class="keywordflow">if</span> (!is_server) {</div><div class="line">        <span class="comment">/* Client sends a message to the server using the Tag-Matching API */</span></div><div class="line">        param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.send = send_cb;</div><div class="line">        request       = <a name="a33"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ga8323878b60f426c630d4ff8996ede3cc">ucp_tag_send_nbx</a>(ep, test_message, TEST_STRING_LEN,</div><div class="line">                                         TAG, &amp;param);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* Server receives a message from the client using the Tag-Matching API */</span></div><div class="line">        param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.recv = tag_recv_cb;</div><div class="line">        request       = <a name="a34"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gaa842f8ca8ad1363ed857ab938285a16f">ucp_tag_recv_nbx</a>(ucp_worker, &amp;recv_message,</div><div class="line">                                         TEST_STRING_LEN, TAG, 0, &amp;param);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> request_finalize(ucp_worker, request, &amp;ctx, is_server, recv_message,</div><div class="line">                            current_iter);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> ucp_am_data_cb(<span class="keywordtype">void</span> *arg, <span class="keyword">const</span> <span class="keywordtype">void</span> *header, <span class="keywordtype">size_t</span> header_length,</div><div class="line">                            <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> length,</div><div class="line">                            <span class="keyword">const</span> <a name="_a35"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#structucp__am__recv__param">ucp_am_recv_param_t</a> *param)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (length != TEST_STRING_LEN) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;received wrong data length %ld (expected %ld)&quot;</span>,</div><div class="line">                length, TEST_STRING_LEN);</div><div class="line">        <span class="keywordflow">goto</span> out;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((header != NULL) || (header_length != 0)) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;received unexpected header, length %ld&quot;</span>, header_length);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (param-&gt;<a name="a36"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#a53a8777a31faf7e65289bcc1d710fb19">recv_attr</a> &amp; <a name="a37"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gga487a3c588a11e42b9f313f0c9e2ead3baf9a8d75af5b826d7563863591a98714f">UCP_AM_RECV_ATTR_FLAG_RNDV</a>) {</div><div class="line">        <span class="comment">/* Rendezvous request arrived, data contains an internal UCX descriptor,</span></div><div class="line"><span class="comment">         * which has to be passed to ucp_am_recv_data_nbx function to confirm</span></div><div class="line"><span class="comment">         * data transfer.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        am_data_desc.is_rndv = 1;</div><div class="line">        am_data_desc.desc    = data;</div><div class="line">        <span class="keywordflow">return</span> <a name="a38"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a77aa02620851779729e4ad6ceb41f84a">UCS_INPROGRESS</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Message delivered with eager protocol, data should be available</span></div><div class="line"><span class="comment">     * immediately</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    am_data_desc.is_rndv = 0;</div><div class="line">    memcpy(am_data_desc.recv_buf, data, length);</div><div class="line"></div><div class="line">out:</div><div class="line">    am_data_desc.complete = 1;</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> send_recv_am(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep, <span class="keywordtype">int</span> is_server,</div><div class="line">                        <span class="keywordtype">int</span> current_iter)</div><div class="line">{</div><div class="line">    <span class="keywordtype">char</span> recv_message[TEST_STRING_LEN] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line">    test_req_t *request;</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__request__param__t">ucp_request_param_t</a> params;</div><div class="line">    test_req_t ctx;</div><div class="line"></div><div class="line">    am_data_desc.recv_buf = recv_message;</div><div class="line">    ctx.complete          = 0;</div><div class="line">    params.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a>   = <a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a73e3a6e8b96b37ec1b0764e67dd13602">UCP_OP_ATTR_FIELD_CALLBACK</a> |</div><div class="line">                            <a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610af6f932f15331fe7c9efacbfe2578e5ec">UCP_OP_ATTR_FIELD_USER_DATA</a>;</div><div class="line">    params.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#aa9092d65a2e4e55368ca4f88775c190b">user_data</a>      = &amp;ctx;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (is_server) {</div><div class="line">        <span class="keywordflow">while</span> (!am_data_desc.complete) {</div><div class="line">            <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line">        }</div><div class="line">        am_data_desc.complete = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (am_data_desc.is_rndv) {</div><div class="line">            <span class="comment">/* Rendezvous request has arrived, need to invoke receive operation</span></div><div class="line"><span class="comment">             * to confirm data transfer from the sender to the &quot;recv_message&quot;</span></div><div class="line"><span class="comment">             * buffer. */</span></div><div class="line">            params.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a> |= <a name="a39"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a8805045d48573e9aa5751b439be114d0">UCP_OP_ATTR_FLAG_NO_IMM_CMPL</a>;</div><div class="line">            params.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.recv_am    = am_recv_cb,</div><div class="line">            request              = <a name="a40"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gaefaaa5e0a154efe496ae5bb7f2bf71f3">ucp_am_recv_data_nbx</a>(ucp_worker,</div><div class="line">                                                        am_data_desc.desc,</div><div class="line">                                                        &amp;recv_message,</div><div class="line">                                                        TEST_STRING_LEN,</div><div class="line">                                                        &amp;params);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            <span class="comment">/* Data has arrived eagerly and is ready for use, no need to</span></div><div class="line"><span class="comment">             * initiate receive operation. */</span></div><div class="line">            request = NULL;</div><div class="line">        }</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* Client sends a message to the server using the AM API */</span></div><div class="line">        params.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a43bb8fd4782ff74f3d93d4356ce0242d">cb</a>.send = (<a name="a41"></a><a class="code" href="group___u_c_p___c_o_m_m.html#gaee41a74074b37f96dad5b29c9af17faf">ucp_send_nbx_callback_t</a>)send_cb,</div><div class="line">        request        = <a name="a42"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ga4b8ab214f35828ee4608d73442e8c372">ucp_am_send_nbx</a>(ep, TEST_AM_ID, NULL, 0ul,</div><div class="line">                                         test_message, TEST_STRING_LEN,</div><div class="line">                                         &amp;params);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> request_finalize(ucp_worker, request, &amp;ctx, is_server, recv_message,</div><div class="line">                            current_iter);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ep_close(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#structucp__request__param__t">ucp_request_param_t</a> param;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <span class="keywordtype">void</span> *close_req;</div><div class="line"></div><div class="line">    param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a97e9444548efb351db6a07130fb69c28">op_attr_mask</a> = <a class="code" href="group___u_c_p___c_o_m_m.html#gga67fae646dd1668efba6efe49a35a6610a2f2586686e21b2700fd7cd4a8efb5a1b">UCP_OP_ATTR_FIELD_FLAGS</a>;</div><div class="line">    param.<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#a55a8ff2559470c5def6077a86ee9d898">flags</a>        = <a name="a43"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggacef728a5ee7a11f50794544aa259fe71a5b827bc555062bcba501faa3f40e789b">UCP_EP_CLOSE_FLAG_FORCE</a>;</div><div class="line">    close_req          = <a name="a44"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga6756b434213a424abb0d542fda1d82a1">ucp_ep_close_nbx</a>(ep, &amp;param);</div><div class="line">    <span class="keywordflow">if</span> (UCS_PTR_IS_PTR(close_req)) {</div><div class="line">        <span class="keywordflow">do</span> {</div><div class="line">            <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line">            status = <a class="code" href="group___u_c_p___c_o_m_m.html#gae082ad7af428645ebe6e469d3d06a757">ucp_request_check_status</a>(close_req);</div><div class="line">        } <span class="keywordflow">while</span> (status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a77aa02620851779729e4ad6ceb41f84a">UCS_INPROGRESS</a>);</div><div class="line"></div><div class="line">        <a class="code" href="group___u_c_p___c_o_m_m.html#ga0e8e46f5953d464382b21edef3ec9994">ucp_request_free</a>(close_req);</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (UCS_PTR_STATUS(close_req) != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to close ep %p\n&quot;</span>, (<span class="keywordtype">void</span>*)ep);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage()</div><div class="line">{</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Usage: ucp_client_server [parameters]\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;UCP client-server example utility\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\nParameters are:\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot; -a Set IP address of the server &quot;</span></div><div class="line">                    <span class="stringliteral">&quot;(required for client and should not be specified &quot;</span></div><div class="line">                    <span class="stringliteral">&quot;for the server)\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot; -l Set IP address where server listens &quot;</span></div><div class="line">                    <span class="stringliteral">&quot;(If not specified, server uses INADDR_ANY; &quot;</span></div><div class="line">                    <span class="stringliteral">&quot;Irrelevant at client)\n&quot;</span>);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot; -p Port number to listen/connect to (default = %d). &quot;</span></div><div class="line">                    <span class="stringliteral">&quot;0 on the server side means select a random port and print it\n&quot;</span>,</div><div class="line">                    DEFAULT_PORT);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot; -c Communication type for the client and server. &quot;</span></div><div class="line">                    <span class="stringliteral">&quot; Valid values are:\n&quot;</span></div><div class="line">                    <span class="stringliteral">&quot;     &#39;stream&#39; : Stream API\n&quot;</span></div><div class="line">                    <span class="stringliteral">&quot;     &#39;tag&#39;    : Tag API\n&quot;</span></div><div class="line">                    <span class="stringliteral">&quot;     &#39;am&#39;     : AM API\n&quot;</span></div><div class="line">                    <span class="stringliteral">&quot;    If not specified, %s API will be used.\n&quot;</span>, COMM_TYPE_DEFAULT);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot; -i Number of iterations to run. Client and server must &quot;</span></div><div class="line">                    <span class="stringliteral">&quot;have the same value. (default = %d).\n&quot;</span>,</div><div class="line">                    num_iterations);</div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> parse_cmd(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *<span class="keyword">const</span> argv[], <span class="keywordtype">char</span> **server_addr,</div><div class="line">                     <span class="keywordtype">char</span> **listen_addr, send_recv_type_t *send_recv_type)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> c = 0;</div><div class="line">    <span class="keywordtype">int</span> port;</div><div class="line"></div><div class="line">    opterr = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">&quot;a:l:p:c:i:&quot;</span>)) != -1) {</div><div class="line">        <span class="keywordflow">switch</span> (c) {</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:</div><div class="line">            *server_addr = optarg;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div><div class="line">            <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">&quot;stream&quot;</span>)) {</div><div class="line">                *send_recv_type = CLIENT_SERVER_SEND_RECV_STREAM;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">&quot;tag&quot;</span>)) {</div><div class="line">                *send_recv_type = CLIENT_SERVER_SEND_RECV_TAG;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(optarg, <span class="stringliteral">&quot;am&quot;</span>)) {</div><div class="line">                <span class="comment">/* TODO: uncomment below when AM API is fully supported.</span></div><div class="line"><span class="comment">                 * *send_recv_type = CLIENT_SERVER_SEND_RECV_AM; */</span></div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;AM API is not fully supported yet\n&quot;</span>);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">            } <span class="keywordflow">else</span> {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Wrong communication type %s. &quot;</span></div><div class="line">                        <span class="stringliteral">&quot;Using %s as default\n&quot;</span>, optarg, COMM_TYPE_DEFAULT);</div><div class="line">                *send_recv_type = CLIENT_SERVER_SEND_RECV_DEFAULT;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>:</div><div class="line">            *listen_addr = optarg;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div><div class="line">            port = atoi(optarg);</div><div class="line">            <span class="keywordflow">if</span> ((port &lt; 0) || (port &gt; UINT16_MAX)) {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Wrong server port number %d\n&quot;</span>, port);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">            }</div><div class="line">            server_port = port;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:</div><div class="line">            num_iterations = atoi(optarg);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            usage();</div><div class="line">            <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span>* sockaddr_get_ip_str(<span class="keyword">const</span> <span class="keyword">struct</span> sockaddr_storage *sock_addr,</div><div class="line">                                 <span class="keywordtype">char</span> *ip_str, <span class="keywordtype">size_t</span> max_size)</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>sockaddr_in  addr_in;</div><div class="line">    <span class="keyword">struct </span>sockaddr_in6 addr_in6;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (sock_addr-&gt;ss_family) {</div><div class="line">    <span class="keywordflow">case</span> AF_INET:</div><div class="line">        memcpy(&amp;addr_in, sock_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in));</div><div class="line">        inet_ntop(AF_INET, &amp;addr_in.sin_addr, ip_str, max_size);</div><div class="line">        <span class="keywordflow">return</span> ip_str;</div><div class="line">    <span class="keywordflow">case</span> AF_INET6:</div><div class="line">        memcpy(&amp;addr_in6, sock_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in6));</div><div class="line">        inet_ntop(AF_INET6, &amp;addr_in6.sin6_addr, ip_str, max_size);</div><div class="line">        <span class="keywordflow">return</span> ip_str;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Invalid address family&quot;</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span>* sockaddr_get_port_str(<span class="keyword">const</span> <span class="keyword">struct</span> sockaddr_storage *sock_addr,</div><div class="line">                                   <span class="keywordtype">char</span> *port_str, <span class="keywordtype">size_t</span> max_size)</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>sockaddr_in  addr_in;</div><div class="line">    <span class="keyword">struct </span>sockaddr_in6 addr_in6;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (sock_addr-&gt;ss_family) {</div><div class="line">    <span class="keywordflow">case</span> AF_INET:</div><div class="line">        memcpy(&amp;addr_in, sock_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in));</div><div class="line">        snprintf(port_str, max_size, <span class="stringliteral">&quot;%d&quot;</span>, ntohs(addr_in.sin_port));</div><div class="line">        <span class="keywordflow">return</span> port_str;</div><div class="line">    <span class="keywordflow">case</span> AF_INET6:</div><div class="line">        memcpy(&amp;addr_in6, sock_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in6));</div><div class="line">        snprintf(port_str, max_size, <span class="stringliteral">&quot;%d&quot;</span>, ntohs(addr_in6.sin6_port));</div><div class="line">        <span class="keywordflow">return</span> port_str;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Invalid address family&quot;</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> client_server_communication(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> worker, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep,</div><div class="line">                                       send_recv_type_t send_recv_type,</div><div class="line">                                       <span class="keywordtype">int</span> is_server, <span class="keywordtype">int</span> current_iter)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (send_recv_type) {</div><div class="line">    <span class="keywordflow">case</span> CLIENT_SERVER_SEND_RECV_STREAM:</div><div class="line">        <span class="comment">/* Client-Server communication via Stream API */</span></div><div class="line">        ret = send_recv_stream(worker, ep, is_server, current_iter);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">case</span> CLIENT_SERVER_SEND_RECV_TAG:</div><div class="line">        <span class="comment">/* Client-Server communication via Tag-Matching API */</span></div><div class="line">        ret = send_recv_tag(worker, ep, is_server, current_iter);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">case</span> CLIENT_SERVER_SEND_RECV_AM:</div><div class="line">        <span class="comment">/* Client-Server communication via AM API. */</span></div><div class="line">        ret = send_recv_am(worker, ep, is_server, current_iter);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;unknown send-recv type %d\n&quot;</span>, send_recv_type);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> init_worker(<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ga0e40ddc46f0bbe868a13f6ab1b674f76">ucp_context_h</a> ucp_context, <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> *ucp_worker)</div><div class="line">{</div><div class="line">    <a name="_a45"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#structucp__worker__params">ucp_worker_params_t</a> worker_params;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    memset(&amp;worker_params, 0, <span class="keyword">sizeof</span>(worker_params));</div><div class="line"></div><div class="line">    worker_params.<a name="a46"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#a33863ec848e47f79d2e14181fe2aa921">field_mask</a>  = <a name="a47"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ggadbfc8fd5eaa65351d1617f2f158b80f6a651598f7340d42cafb0876d918c83ec8">UCP_WORKER_PARAM_FIELD_THREAD_MODE</a>;</div><div class="line">    worker_params.<a name="a48"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#a790642ea681ddd2b0935ad62f70e4ef1">thread_mode</a> = <a name="a49"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga40e9f363c389e702ad9920f5d52525ceabc2f71e39a3527f7abe6a1c47f0a5a25">UCS_THREAD_MODE_SINGLE</a>;</div><div class="line"></div><div class="line">    status = <a name="a50"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga0aec01ed3dad646ca6cd3814b13054b1">ucp_worker_create</a>(ucp_context, &amp;worker_params, ucp_worker);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to ucp_worker_create (%s)\n&quot;</span>, ucs_status_string(status));</div><div class="line">        ret = -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> server_conn_handle_cb(<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga200570bfa7d3a8b50b2a074aaa22d2ed">ucp_conn_request_h</a> conn_request, <span class="keywordtype">void</span> *arg)</div><div class="line">{</div><div class="line">    ucx_server_ctx_t *context = arg;</div><div class="line">    <a name="_a51"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#structucp__conn__request__attr">ucp_conn_request_attr_t</a> attr;</div><div class="line">    <span class="keywordtype">char</span> ip_str[IP_STRING_LEN];</div><div class="line">    <span class="keywordtype">char</span> port_str[PORT_STRING_LEN];</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line"></div><div class="line">    attr.<a name="a52"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ad6a97d8268992c34631ac773a6c2148b">field_mask</a> = <a name="a53"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#gga31119b42b06b185822699697bd7a1018a98d3bca4557571d8ccb56ae2d29b2ad6">UCP_CONN_REQUEST_ATTR_FIELD_CLIENT_ADDR</a>;</div><div class="line">    status = <a name="a54"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga440c99f2462ba8201280687a76fd8569">ucp_conn_request_query</a>(conn_request, &amp;attr);</div><div class="line">    <span class="keywordflow">if</span> (status == <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        printf(<span class="stringliteral">&quot;Server received a connection request from client at address %s:%s\n&quot;</span>,</div><div class="line">               sockaddr_get_ip_str(&amp;attr.<a name="a55"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#a8ca1dc70d395335dc9f8fe20e9de1a0d">client_address</a>, ip_str, <span class="keyword">sizeof</span>(ip_str)),</div><div class="line">               sockaddr_get_port_str(&amp;attr.<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#a8ca1dc70d395335dc9f8fe20e9de1a0d">client_address</a>, port_str, <span class="keyword">sizeof</span>(port_str)));</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != <a name="a56"></a><a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a252c38290855ceaf849c04b7fa52dc23">UCS_ERR_UNSUPPORTED</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to query the connection request (%s)\n&quot;</span>,</div><div class="line">                ucs_status_string(status));</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (context-&gt;conn_request == NULL) {</div><div class="line">        context-&gt;conn_request = conn_request;</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* The server is already handling a connection request from a client,</span></div><div class="line"><span class="comment">         * reject this new one */</span></div><div class="line">        printf(<span class="stringliteral">&quot;Rejecting a connection request. &quot;</span></div><div class="line">               <span class="stringliteral">&quot;Only one client at a time is supported.\n&quot;</span>);</div><div class="line">        status = <a name="a57"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga1f1620fdbae11ea076875fd6ac644241">ucp_listener_reject</a>(context-&gt;listener, conn_request);</div><div class="line">        <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;server failed to reject a connection request: (%s)\n&quot;</span>,</div><div class="line">                    ucs_status_string(status));</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> server_create_ep(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> data_worker,</div><div class="line">                                     <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga200570bfa7d3a8b50b2a074aaa22d2ed">ucp_conn_request_h</a> conn_request,</div><div class="line">                                     <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> *server_ep)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#structucp__ep__params">ucp_ep_params_t</a> ep_params;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>    status;</div><div class="line"></div><div class="line">    <span class="comment">/* Server creates an ep to the client on the data worker.</span></div><div class="line"><span class="comment">     * This is not the worker the listener was created on.</span></div><div class="line"><span class="comment">     * The client side should have initiated the connection, leading</span></div><div class="line"><span class="comment">     * to this ep&#39;s creation */</span></div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ab7b3f3ba1d402a621b8ea708dcf2387b">field_mask</a>      = <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60adc6619f5e4bf3f68190f918ee064036d">UCP_EP_PARAM_FIELD_ERR_HANDLER</a> |</div><div class="line">                                <a name="a58"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ggabb6ce0b3189f415dadc7f99727751d60a88c2cf7c57a1cddc6b2cf9bcdc99e64e">UCP_EP_PARAM_FIELD_CONN_REQUEST</a>;</div><div class="line">    ep_params.<a name="a59"></a><a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#a9fbba62cd4a470f2bc7c6f7e55fe3db1">conn_request</a>    = conn_request;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aaf329de9e2b45311099cee8c9df43a20">err_handler</a>.<a class="code" href="group___u_c_p___c_o_m_m.html#a0bf3f446a1821a62dd3a300584792e33">cb</a>  = err_cb;</div><div class="line">    ep_params.<a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#aaf329de9e2b45311099cee8c9df43a20">err_handler</a>.<a class="code" href="group___u_c_p___c_o_m_m.html#a7e49e1843e1adab5561e5fc2b2e1afb1">arg</a> = NULL;</div><div class="line"></div><div class="line">    status = <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga6cc5ffb2ba1b0ccd510848de0a779f7b">ucp_ep_create</a>(data_worker, &amp;ep_params, server_ep);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to create an endpoint on the server: (%s)\n&quot;</span>,</div><div class="line">                ucs_status_string(status));</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> start_server(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker,</div><div class="line">                                 ucx_server_ctx_t *context,</div><div class="line">                                 <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#gac0496f7102c43cf339cc760b9e5724a2">ucp_listener_h</a> *listener_p, <span class="keyword">const</span> <span class="keywordtype">char</span> *ip)</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>sockaddr_in listen_addr;</div><div class="line">    <a name="_a60"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#structucp__listener__params">ucp_listener_params_t</a> params;</div><div class="line">    <a name="_a61"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#structucp__listener__attr">ucp_listener_attr_t</a> attr;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <span class="keywordtype">char</span> ip_str[IP_STRING_LEN];</div><div class="line">    <span class="keywordtype">char</span> port_str[PORT_STRING_LEN];</div><div class="line"></div><div class="line">    set_listen_addr(ip, &amp;listen_addr);</div><div class="line"></div><div class="line">    params.field_mask         = <a name="a62"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#gga36d95269fcce844261494cbd4f5e26fca0eed5ab19654fabc0afceb5b439c6f05">UCP_LISTENER_PARAM_FIELD_SOCK_ADDR</a> |</div><div class="line">                                <a name="a63"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#gga36d95269fcce844261494cbd4f5e26fca6f28cd3c96e0ada4fafc63d6f67e48bc">UCP_LISTENER_PARAM_FIELD_CONN_HANDLER</a>;</div><div class="line">    params.sockaddr.addr      = (<span class="keyword">const</span> <span class="keyword">struct </span>sockaddr*)&amp;listen_addr;</div><div class="line">    params.sockaddr.addrlen   = <span class="keyword">sizeof</span>(listen_addr);</div><div class="line">    params.conn_handler.cb    = server_conn_handle_cb;</div><div class="line">    params.conn_handler.arg   = context;</div><div class="line"></div><div class="line">    <span class="comment">/* Create a listener on the server side to listen on the given address.*/</span></div><div class="line">    status = <a name="a64"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga7a8943f89a7b49c1f1abc562fb5178ad">ucp_listener_create</a>(ucp_worker, &amp;params, listener_p);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to listen (%s)\n&quot;</span>, ucs_status_string(status));</div><div class="line">        <span class="keywordflow">goto</span> out;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Query the created listener to get the port it is listening on. */</span></div><div class="line">    attr.<a name="a65"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#aaaa6353f56fd585d7c83c363380703f4">field_mask</a> = <a name="a66"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#gga54059507b51041359aedffbe75635720a5a58fea3f5a4daa6b055306a6798ec26">UCP_LISTENER_ATTR_FIELD_SOCKADDR</a>;</div><div class="line">    status = <a name="a67"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga785a8cc6adab6c01bb2354a38bcd9928">ucp_listener_query</a>(*listener_p, &amp;attr);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to query the listener (%s)\n&quot;</span>,</div><div class="line">                ucs_status_string(status));</div><div class="line">        <a name="a68"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#gae45c609cd659bdd0e205d30627b7af21">ucp_listener_destroy</a>(*listener_p);</div><div class="line">        <span class="keywordflow">goto</span> out;</div><div class="line">    }</div><div class="line"></div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;server is listening on IP %s port %s\n&quot;</span>,</div><div class="line">            sockaddr_get_ip_str(&amp;attr.<a name="a69"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#affcc213cd4305412937974eefb95bc32">sockaddr</a>, ip_str, IP_STRING_LEN),</div><div class="line">            sockaddr_get_port_str(&amp;attr.<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#affcc213cd4305412937974eefb95bc32">sockaddr</a>, port_str, PORT_STRING_LEN));</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Waiting for connection...\n&quot;</span>);</div><div class="line"></div><div class="line">out:</div><div class="line">    <span class="keywordflow">return</span> status;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> client_server_do_work(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a> ep,</div><div class="line">                                 send_recv_type_t send_recv_type, <span class="keywordtype">int</span> is_server)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> i, ret = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_iterations; i++) {</div><div class="line">        ret = client_server_communication(ucp_worker, ep, send_recv_type,</div><div class="line">                                          is_server, i);</div><div class="line">        <span class="keywordflow">if</span> (ret != 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;%s failed on iteration #%d\n&quot;</span>,</div><div class="line">                    (is_server ? <span class="stringliteral">&quot;server&quot;</span>: <span class="stringliteral">&quot;client&quot;</span>), i + 1);</div><div class="line">            <span class="keywordflow">goto</span> out;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">out:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> run_server(<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ga0e40ddc46f0bbe868a13f6ab1b674f76">ucp_context_h</a> ucp_context, <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker,</div><div class="line">                      <span class="keywordtype">char</span> *listen_addr, send_recv_type_t send_recv_type)</div><div class="line">{</div><div class="line">    ucx_server_ctx_t context;</div><div class="line">    <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a>     ucp_data_worker;</div><div class="line">    <a name="_a70"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#structucp__am__handler__param">ucp_am_handler_param_t</a> param;</div><div class="line">    <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a>         server_ep;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a>     status;</div><div class="line">    <span class="keywordtype">int</span>              ret;</div><div class="line"></div><div class="line">    <span class="comment">/* Create a data worker (to be used for data exchange between the server</span></div><div class="line"><span class="comment">     * and the client after the connection between them was established) */</span></div><div class="line">    ret = init_worker(ucp_context, &amp;ucp_data_worker);</div><div class="line">    <span class="keywordflow">if</span> (ret != 0) {</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (send_recv_type == CLIENT_SERVER_SEND_RECV_AM) {</div><div class="line">        <span class="comment">/* Initialize Active Message data handler */</span></div><div class="line">        param.<a name="a71"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#a8f31d53e411769961286865cb9332f6f">field_mask</a> = <a name="a72"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ggaeae021145933ffa033b8327bb7bf2533a4b9788659b793630cee9bc027add35ad">UCP_AM_HANDLER_PARAM_FIELD_ID</a> |</div><div class="line">                           <a name="a73"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ggaeae021145933ffa033b8327bb7bf2533a6c2a2d3fe9c7118d3513833ad452cb69">UCP_AM_HANDLER_PARAM_FIELD_CB</a> |</div><div class="line">                           <a name="a74"></a><a class="code" href="group___u_c_p___c_o_m_m.html#ggaeae021145933ffa033b8327bb7bf2533a23622f1a9046a0b59d1519732e2b73ff">UCP_AM_HANDLER_PARAM_FIELD_ARG</a>;</div><div class="line">        param.<a name="a75"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ad0c6157f387e18cb4d92a37a638274af">id</a>         = TEST_AM_ID;</div><div class="line">        param.<a name="a76"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#acd54cdefba3f3f5e145dfe2360485659">cb</a>         = ucp_am_data_cb;</div><div class="line">        param.<a name="a77"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ae1670a4926d8528fb1ec1cd3f461f13a">arg</a>        = ucp_data_worker; <span class="comment">/* not used in our callback */</span></div><div class="line">        status           = <a name="a78"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga410d5e90c2abc6997924cbf7dee4a1f3">ucp_worker_set_am_recv_handler</a>(ucp_data_worker,</div><div class="line">                                                          &amp;param);</div><div class="line">        <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">            ret = -1;</div><div class="line">            <span class="keywordflow">goto</span> err_worker;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the server&#39;s context. */</span></div><div class="line">    context.conn_request = NULL;</div><div class="line"></div><div class="line">    <span class="comment">/* Create a listener on the worker created at first. The &#39;connection</span></div><div class="line"><span class="comment">     * worker&#39; - used for connection establishment between client and server.</span></div><div class="line"><span class="comment">     * This listener will stay open for listening to incoming connection</span></div><div class="line"><span class="comment">     * requests from the client */</span></div><div class="line">    status = start_server(ucp_worker, &amp;context, &amp;context.listener, listen_addr);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        ret = -1;</div><div class="line">        <span class="keywordflow">goto</span> err_worker;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Server is always up listening */</span></div><div class="line">    <span class="keywordflow">while</span> (1) {</div><div class="line">        <span class="comment">/* Wait for the server to receive a connection request from the client.</span></div><div class="line"><span class="comment">         * If there are multiple clients for which the server&#39;s connection request</span></div><div class="line"><span class="comment">         * callback is invoked, i.e. several clients are trying to connect in</span></div><div class="line"><span class="comment">         * parallel, the server will handle only the first one and reject the rest */</span></div><div class="line">        <span class="keywordflow">while</span> (context.conn_request == NULL) {</div><div class="line">            <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga340784a8528d4932916651460dc481c0">ucp_worker_progress</a>(ucp_worker);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Server creates an ep to the client on the data worker.</span></div><div class="line"><span class="comment">         * This is not the worker the listener was created on.</span></div><div class="line"><span class="comment">         * The client side should have initiated the connection, leading</span></div><div class="line"><span class="comment">         * to this ep&#39;s creation */</span></div><div class="line">        status = server_create_ep(ucp_data_worker, context.conn_request,</div><div class="line">                                  &amp;server_ep);</div><div class="line">        <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">            ret = -1;</div><div class="line">            <span class="keywordflow">goto</span> err_listener;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* The server waits for all the iterations to complete before moving on</span></div><div class="line"><span class="comment">         * to the next client */</span></div><div class="line">        ret = client_server_do_work(ucp_data_worker, server_ep, send_recv_type,</div><div class="line">                                    1);</div><div class="line">        <span class="keywordflow">if</span> (ret != 0) {</div><div class="line">            <span class="keywordflow">goto</span> err_ep;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Close the endpoint to the client */</span></div><div class="line">        ep_close(ucp_data_worker, server_ep);</div><div class="line"></div><div class="line">        <span class="comment">/* Reinitialize the server&#39;s context to be used for the next client */</span></div><div class="line">        context.conn_request = NULL;</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Waiting for connection...\n&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">err_ep:</div><div class="line">    ep_close(ucp_data_worker, server_ep);</div><div class="line">err_listener:</div><div class="line">    <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#gae45c609cd659bdd0e205d30627b7af21">ucp_listener_destroy</a>(context.listener);</div><div class="line">err_worker:</div><div class="line">    <a name="a79"></a><a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga6b6c5bf97d16e7fc4b7c815875e92676">ucp_worker_destroy</a>(ucp_data_worker);</div><div class="line">err:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> run_client(<a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> ucp_worker, <span class="keywordtype">char</span> *server_addr,</div><div class="line">                      send_recv_type_t send_recv_type)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_c_p___e_n_d_p_o_i_n_t.html#ga9bea4e4174ea25f44285d8e7a9fb7adf">ucp_ep_h</a>     client_ep;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <span class="keywordtype">int</span>          ret;</div><div class="line"></div><div class="line">    status = start_client(ucp_worker, server_addr, &amp;client_ep);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to start client (%s)\n&quot;</span>, ucs_status_string(status));</div><div class="line">        ret = -1;</div><div class="line">        <span class="keywordflow">goto</span> out;</div><div class="line">    }</div><div class="line"></div><div class="line">    ret = client_server_do_work(ucp_worker, client_ep, send_recv_type, 0);</div><div class="line"></div><div class="line">    <span class="comment">/* Close the endpoint to the server */</span></div><div class="line">    ep_close(ucp_worker, client_ep);</div><div class="line"></div><div class="line">out:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> init_context(<a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ga0e40ddc46f0bbe868a13f6ab1b674f76">ucp_context_h</a> *ucp_context, <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a> *ucp_worker,</div><div class="line">                        send_recv_type_t send_recv_type)</div><div class="line">{</div><div class="line">    <span class="comment">/* UCP objects */</span></div><div class="line">    <a name="_a80"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params_t</a> <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>;</div><div class="line">    <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#ga88ca72d7294772e7d2edb70a2df15558">ucs_status_t</a> status;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    memset(&amp;<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>));</div><div class="line"></div><div class="line">    <span class="comment">/* UCP initialization */</span></div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a name="a81"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#a62d432cd22de13ccc9bb12edeb9c566b">field_mask</a> = <a name="a82"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggab43f613a2365147415abf66f571cfa71a454f1e90a324095192d87d97b8a4321f">UCP_PARAM_FIELD_FEATURES</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (send_recv_type == CLIENT_SERVER_SEND_RECV_STREAM) {</div><div class="line">        <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a name="a83"></a><a class="code" href="group___u_c_p___c_o_n_f_i_g.html#afe7ed2a6c6ceb48e18a04f524d844e67">features</a> = <a name="a84"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggaca5990bc015e7e9ac3e3be4e3611c5bea0c3896ead0887f9c650b221831e16b5c">UCP_FEATURE_STREAM</a>;</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (send_recv_type == CLIENT_SERVER_SEND_RECV_TAG) {</div><div class="line">        <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#afe7ed2a6c6ceb48e18a04f524d844e67">features</a> = <a name="a85"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggaca5990bc015e7e9ac3e3be4e3611c5bea244187ad85296b3784d302db00f66b9e">UCP_FEATURE_TAG</a>;</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>.<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#afe7ed2a6c6ceb48e18a04f524d844e67">features</a> = <a name="a86"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ggaca5990bc015e7e9ac3e3be4e3611c5bea685931b9f438fa9a2faaf9eccf47b097">UCP_FEATURE_AM</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    status = <a name="a87"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ga3ad3662ebafac88ec666be4caeb76cb2">ucp_init</a>(&amp;<a class="code" href="group___u_c_p___c_o_n_f_i_g.html#structucp__params">ucp_params</a>, NULL, ucp_context);</div><div class="line">    <span class="keywordflow">if</span> (status != <a class="code" href="group___u_c_s___r_e_s_o_u_r_c_e.html#gga88ca72d7294772e7d2edb70a2df15558a1a7fbae02ac33fb94f519c7c773f419a">UCS_OK</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to ucp_init (%s)\n&quot;</span>, ucs_status_string(status));</div><div class="line">        ret = -1;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    ret = init_worker(*ucp_context, ucp_worker);</div><div class="line">    <span class="keywordflow">if</span> (ret != 0) {</div><div class="line">        <span class="keywordflow">goto</span> err_cleanup;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line"></div><div class="line">err_cleanup:</div><div class="line">    <a name="a88"></a><a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#gaaa7a90069ad6e0f3e227402db265299e">ucp_cleanup</a>(*ucp_context);</div><div class="line">err:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">    send_recv_type_t send_recv_type = CLIENT_SERVER_SEND_RECV_DEFAULT;</div><div class="line">    <span class="keywordtype">char</span> *server_addr = NULL;</div><div class="line">    <span class="keywordtype">char</span> *listen_addr = NULL;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line"></div><div class="line">    <span class="comment">/* UCP objects */</span></div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#ga0e40ddc46f0bbe868a13f6ab1b674f76">ucp_context_h</a> ucp_context;</div><div class="line">    <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga5fd52efba31d20fc52055bb19270729f">ucp_worker_h</a>  ucp_worker;</div><div class="line"></div><div class="line">    ret = parse_cmd(argc, argv, &amp;server_addr, &amp;listen_addr, &amp;send_recv_type);</div><div class="line">    <span class="keywordflow">if</span> (ret != 0) {</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the UCX required objects */</span></div><div class="line">    ret = init_context(&amp;ucp_context, &amp;ucp_worker, send_recv_type);</div><div class="line">    <span class="keywordflow">if</span> (ret != 0) {</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Client-Server initialization */</span></div><div class="line">    <span class="keywordflow">if</span> (server_addr == NULL) {</div><div class="line">        <span class="comment">/* Server side */</span></div><div class="line">        ret = run_server(ucp_context, ucp_worker, listen_addr, send_recv_type);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* Client side */</span></div><div class="line">        ret = run_client(ucp_worker, server_addr, send_recv_type);</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___u_c_p___w_o_r_k_e_r.html#ga6b6c5bf97d16e7fc4b7c815875e92676">ucp_worker_destroy</a>(ucp_worker);</div><div class="line">    <a class="code" href="group___u_c_p___c_o_n_t_e_x_t.html#gaaa7a90069ad6e0f3e227402db265299e">ucp_cleanup</a>(ucp_context);</div><div class="line">err:</div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Mar 15 2021 11:12:06 for UCX by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
